<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager - KES Solutions</title>
    <link rel="stylesheet" href="manager.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>‚ö° KES MANAGER</h2>
        <button class="nav-btn active" onclick="showView('dashboard')">üìä Tableau de bord</button>
        <button class="nav-btn" onclick="showView('societe')">üè¢ Ma Soci√©t√©</button>
        <button class="nav-btn" onclick="showView('interventions')">üìã Interventions</button>
        <button class="nav-btn" onclick="showView('techniciens')">üë∑ √âquipe & Techniciens</button>
        <button class="nav-btn" onclick="showView('carte')">üó∫Ô∏è Carte des Techniciens</button>
        <button class="nav-btn" onclick="showView('stats')">üìà Statistiques</button>
        <button class="nav-btn" style="margin-top: auto; color: #dc3545;" onclick="logout()">üö™ D√©connexion</button>
    </div>

    <div class="main-content">
        <header>
            <div>
                <h1 id="page-title">Tableau de bord</h1>
                <p style="color: #888; font-size: 0.9em; margin-top: 5px;">
                    <span id="manager-info"></span>
                </p>
            </div>
            <div style="text-align: right;">
                <img id="company-logo-header" src="" alt="" style="max-height: 60px; display: none; border-radius: 8px;">
            </div>
        </header>

        <!-- Vue Dashboard -->
        <div id="dashboard" class="view active">
            <div class="stats-grid">
                <div class="card"><h3>Total Interventions</h3><p id="stat-total">0</p></div>
                <div class="card"><h3>En cours</h3><p id="stat-encours">0</p></div>
                <div class="card"><h3>Termin√©es</h3><p id="stat-terminees">0</p></div>
                <div class="card"><h3>Techniciens actifs</h3><p id="stat-techs">0</p></div>
            </div>
            <h2>Interventions r√©centes</h2>
            <table>
                <thead><tr><th>N¬∞ Bon</th><th>Client</th><th>Date</th><th>Technicien</th><th>Statut</th></tr></thead>
                <tbody id="recent-table"><tr><td colspan="5" style="text-align:center;color:#888;">Aucune intervention</td></tr></tbody>
            </table>
        </div>

        <!-- Vue Ma Soci√©t√© -->
        <div id="societe" class="view">
            <h2>Profil de l'Entreprise</h2>
            <div style="background: #1a1a1a; padding: 30px; border-radius: 12px;">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                    <div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #aaa; margin-bottom: 5px;">Nom de la Soci√©t√© *</label>
                            <input type="text" id="company-name" style="width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #aaa; margin-bottom: 5px;">SIRET *</label>
                            <input type="text" id="company-siret" maxlength="14" placeholder="14 chiffres" style="width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #aaa; margin-bottom: 5px;">Adresse *</label>
                            <input type="text" id="company-address" style="width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                            <div>
                                <label style="display: block; color: #aaa; margin-bottom: 5px;">Code Postal *</label>
                                <input type="text" id="company-postal" maxlength="5" style="width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; color: #aaa; margin-bottom: 5px;">Ville *</label>
                                <input type="text" id="company-city" style="width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; color: #aaa; margin-bottom: 10px;">Logo de l'Entreprise</label>
                        <div style="border: 2px dashed #444; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; position: relative;" onclick="document.getElementById('logo-upload').click()">
                            <img id="logo-preview" src="" alt="" style="max-width: 100%; max-height: 150px; display: none; border-radius: 8px;">
                            <div id="logo-placeholder">
                                <p style="color: #888; margin-bottom: 10px;">üì∑</p>
                                <p style="color: #888; font-size: 0.9em;">Cliquez pour uploader<br>un logo</p>
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                        </div>
                        <button onclick="removeLogo()" style="width: 100%; margin-top: 10px; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; display: none;" id="remove-logo-btn">Supprimer le logo</button>
                    </div>
                </div>
                <button onclick="saveCompanyProfile()" class="btn-add" style="margin-top: 30px; width: 100%; padding: 15px; font-size: 1em;">üíæ Enregistrer le Profil</button>
            </div>
        </div>

        <!-- Vue Interventions avec bouton cr√©ation -->
        <div id="interventions" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Toutes les interventions</h2>
                <button onclick="openCreateIntervention()" class="btn-add">‚ûï Cr√©er une Intervention</button>
            </div>
            <table>
                <thead><tr><th>N¬∞ Bon</th><th>Client</th><th>Adresse</th><th>Date</th><th>Technicien</th><th>Statut</th><th>Actions</th></tr></thead>
                <tbody id="all-interventions-table"><tr><td colspan="7" style="text-align:center;color:#888;">Aucune intervention</td></tr></tbody>
            </table>
        </div>

        <!-- Vue Techniciens avec planning -->
        <div id="techniciens" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="margin: 0;">√âquipe Technique</h2>
                <button onclick="openAddTechnicianModal()" class="btn-add" style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">‚ûï</span> Ajouter un Technicien
                </button>
            </div>
            <div id="techs-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="text-align: center; color: #888; padding: 40px;">Aucun technicien</div>
            </div>
        </div>

        <!-- Vue Carte des Techniciens -->
        <div id="carte" class="view">
            <h2>Localisation des Techniciens en Temps R√©el</h2>
            <div id="map" style="height: 600px; border-radius: 12px; margin-top: 20px; background: #1a1a1a;"></div>
        </div>

        <!-- Vue Statistiques -->
        <div id="stats" class="view">
            <h2>Statistiques d√©taill√©es</h2>
            <div class="stats-grid">
                <div class="card"><h3>Taux de compl√©tion</h3><p id="stat-completion">0%</p></div>
                <div class="card"><h3>Moyenne / jour</h3><p id="stat-avg">0</p></div>
                <div class="card"><h3>Ce mois</h3><p id="stat-month">0</p></div>
                <div class="card"><h3>Cette semaine</h3><p id="stat-week">0</p></div>
            </div>
        </div>
    </div>

    <!-- Modal Cr√©ation Intervention -->
    <div class="modal" id="modal-create-intervention">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Cr√©er une Intervention</h2>
            <label style="display: block; color: #aaa; margin-bottom: 5px;">Client *</label>
            <input type="text" id="inter-client" placeholder="Nom du client" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
            
            <label style="display: block; color: #aaa; margin-bottom: 5px;">Adresse *</label>
            <input type="text" id="inter-address" placeholder="Adresse compl√®te" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
            
            <label style="display: block; color: #aaa; margin-bottom: 5px;">Type de panne / Description *</label>
            <textarea id="inter-description" rows="3" placeholder="D√©crivez l'intervention..." style="width: 100%; padding: 10px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;"></textarea>
            
            <label style="display: block; color: #aaa; margin-bottom: 5px;">Date *</label>
            <input type="date" id="inter-date" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
            
            <label style="display: block; color: #aaa; margin-bottom: 5px;">Heure *</label>
            <input type="time" id="inter-time" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
            
            <label style="display: block; color: #aaa; margin-bottom: 5px;">Assigner √† *</label>
            <select id="inter-tech" style="width: 100%; padding: 10px; margin-bottom: 20px; background: #333; border: 1px solid #444; color: white; border-radius: 5px;">
                <option value="">S√©lectionner un technicien</option>
            </select>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="closeModal('modal-create-intervention')" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">Annuler</button>
                <button onclick="createIntervention()" class="btn-add" style="flex: 2; padding: 12px;">Cr√©er et Assigner</button>
            </div>
        </div>
    </div>

    <!-- Modal D√©tails Technicien -->
    <div class="modal" id="modal-tech-details">
        <div class="modal-content" style="max-width: 700px;">
            <h2 id="tech-detail-name" style="margin-bottom: 20px;">D√©tails Technicien</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <p style="color: #aaa; margin: 5px 0;">Email</p>
                    <p id="tech-detail-email" style="color: white;"></p>
                </div>
                <div>
                    <p style="color: #aaa; margin: 5px 0;">T√©l√©phone</p>
                    <p id="tech-detail-phone" style="color: white;"></p>
                </div>
            </div>
            <h3 style="margin: 20px 0 10px 0; color: #007bff;">Planning des Interventions</h3>
            <div id="tech-planning" style="max-height: 300px; overflow-y: auto;">
                <p style="color: #888; text-align: center; padding: 20px;">Aucune intervention</p>
            </div>
            <button onclick="closeModal('modal-tech-details')" style="width: 100%; margin-top: 20px; padding: 12px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">Fermer</button>
        </div>
    </div>

    <!-- Modal Ajout Technicien - ULTRA COMPACT -->
    <div class="modal" id="modal-add-technician">
        <div class="modal-content" style="max-width: 380px; padding: 25px; position: relative;">
            <h2 style="margin: 0 0 15px 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                üë∑ Nouveau Technicien
            </h2>
            
            <!-- Zone scrollable -->
            <div style="max-height: 400px; overflow-y: auto; padding-right: 5px; margin-bottom: 15px;">
                <!-- Photo mini -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <div id="tech-photo-preview" style="width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 8px; border: 2px solid var(--electric-blue); background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer;" onclick="document.getElementById('tech-photo-input').click()">
                        <img id="tech-photo-img" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        <div id="tech-photo-placeholder">
                            <p style="font-size: 1.3rem; margin: 0;">üì∑</p>
                        </div>
                    </div>
                    <input type="file" id="tech-photo-input" accept="image/*" style="display: none;" onchange="handleTechPhotoUpload(event)">
                    <p style="color: rgba(255, 255, 255, 0.3); font-size: 0.65rem; margin: 0;">Photo (optionnel)</p>
                </div>

                <!-- Champs compacts sans labels -->
                <div style="display: grid; gap: 10px;">
                    <input type="text" id="tech-firstname" placeholder="Pr√©nom *" class="premium-input" style="padding: 9px 12px; font-size: 0.85rem;">
                    <input type="text" id="tech-lastname" placeholder="Nom *" class="premium-input" style="padding: 9px 12px; font-size: 0.85rem;">
                    <input type="email" id="tech-email" placeholder="Email *" class="premium-input" style="padding: 9px 12px; font-size: 0.85rem;">
                    <input type="tel" id="tech-phone" placeholder="T√©l√©phone *" class="premium-input" maxlength="14" style="padding: 9px 12px; font-size: 0.85rem;">
                    <input type="password" id="tech-password" placeholder="Mot de passe *" class="premium-input" style="padding: 9px 12px; font-size: 0.85rem;">
                </div>
            </div>

            <!-- Boutons FIXES en bas - TOUJOURS VISIBLES -->
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px; background: var(--deep-space); padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.05);">
                <button onclick="closeModal('modal-add-technician')" style="padding: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem;">
                    Annuler
                </button>
                <button onclick="saveTechnician()" style="padding: 10px; background: linear-gradient(135deg, #10b981, var(--electric-blue)); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.8rem; box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);">
                    ‚úÖ VALIDER
                </button>
            </div>
        </div>
    </div>

    <!-- Notification de succ√®s -->
    <div id="success-notification" style="position: fixed; top: 30px; right: 30px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(0, 212, 255, 0.95)); backdrop-filter: blur(20px); padding: 20px 30px; border-radius: 16px; border: 1px solid rgba(16, 185, 129, 0.5); box-shadow: 0 0 40px rgba(16, 185, 129, 0.6), 0 8px 32px rgba(0, 0, 0, 0.6); color: white; font-weight: 600; display: none; z-index: 3000; animation: slideInRight 0.5s ease;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.5rem;">‚úÖ</span>
            <span id="notification-text">Technicien ajout√© avec succ√®s !</span>
        </div>
    </div>

    <script src="manager.js"></script>
    <script src="sync-tech.js"></script>
</body>
</html>
