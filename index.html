<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KES Solutions - Gestion des Interventions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0099ff;
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .header .tagline {
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: #374151;
            color: #d1d5db;
        }

        .tab-btn.active {
            background: #0099ff;
            color: #ffffff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0099ff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid #374151;
            color: #ffffff;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #0099ff;
            box-shadow: 0 0 0 3px rgba(0, 153, 255, 0.1);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: #6b7280;
        }

        .form-textarea {
            resize: vertical;
            font-family: inherit;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #0099ff;
            color: #ffffff;
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            box-shadow: 0 4px 24px rgba(0, 153, 255, 0.35);
        }

        .btn-primary:hover {
            background: #0088ee;
            box-shadow: 0 8px 32px rgba(0, 153, 255, 0.45);
        }

        .btn-secondary {
            background: #374151;
            color: #d1d5db;
        }

        .btn-secondary:hover {
            background: #4b5563;
            color: #ffffff;
        }

        .btn-success {
            background: #10b981;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: transparent;
            color: #ef4444;
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .btn-danger:hover {
            text-decoration: underline;
        }

        .btn-dashed {
            width: 100%;
            border: 2px dashed #374151;
            background: transparent;
            color: #6b7280;
            padding: 12px;
        }

        .btn-dashed:hover {
            border-color: #0099ff;
            color: #0099ff;
        }

        .preview-card {
            text-align: center;
            padding: 20px;
        }

        .preview-label {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .preview-number {
            font-size: 2rem;
            font-weight: 700;
            color: #0099ff;
        }

        .intervention-item {
            margin-bottom: 16px;
        }

        .intervention-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .intervention-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: #0099ff;
        }

        .signature-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 12px;
        }

        .signature-canvas {
            border: 2px dashed #0099ff;
            background: #ffffff;
            cursor: crosshair;
            touch-action: none;
            width: 100%;
            border-radius: 8px;
            display: block;
        }
        
        .signature-canvas-wrapper {
            max-height: 150px;
            overflow: hidden;
        }

        .signature-status {
            text-align: center;
            font-size: 0.875rem;
            color: #9ca3af;
            margin-top: 8px;
        }

        .signature-status.saved {
            color: #10b981;
        }

        .history-item {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .history-bon {
            font-size: 1.125rem;
            font-weight: 700;
            color: #0099ff;
        }

        .history-client {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .history-date {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .history-address {
            font-size: 0.875rem;
            color: #d1d5db;
            margin-bottom: 8px;
        }

        .history-meta {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .message {
            padding: 12px;
            border-radius: 12px;
            margin-top: 16px;
            text-align: center;
        }

        .message.success {
            background: #10b981;
            color: #ffffff;
        }

        .message.hidden {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #6b7280;
            font-size: 0.875rem;
        }

        @media (max-width: 640px) {
            .header h1 {
                font-size: 2rem;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: nowrap;
            }

            .glass-card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>KES SOLUTIONS</h1>
            <p class="subtitle">KOPILOTS ENERGIE SYSTEME</p>
            <p class="tagline">Gestion des Bons d'Intervention</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')">
                üë§ Profil
            </button>
            <button class="tab-btn" id="tab-new-bon" onclick="switchTab('new-bon')">
                ‚ûï Nouveau Bon
            </button>
            <button class="tab-btn" id="tab-history" onclick="switchTab('history')">
                üìã Historique
            </button>
        </div>

        <!-- Profile Tab -->
        <div id="content-profile" class="tab-content">
            <div class="glass-card">
                <h2 class="section-title">Informations de l'Entreprise</h2>
                
                <div class="form-group">
                    <label class="form-label">Nom de l'Entreprise</label>
                    <input type="text" id="companyName" class="form-input" placeholder="KES SOLUTIONS">
                </div>
                
                <div class="form-group">
                    <label class="form-label">SIREN</label>
                    <input type="text" id="siren" class="form-input" placeholder="123 456 789">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nom du Technicien</label>
                    <input type="text" id="technicianName" class="form-input" placeholder="Jean Dupont">
                </div>
                
                <button onclick="saveProfile()" class="btn btn-primary">
                    üíæ Enregistrer le Profil
                </button>
                
                <div id="profileMessage" class="message hidden"></div>
            </div>
        </div>

        <!-- New Bon Tab -->
        <div id="content-new-bon" class="tab-content">
            <!-- Preview -->
            <div class="glass-card preview-card">
                <p class="preview-label">Prochain Bon d'Intervention</p>
                <p class="preview-number" id="nextBonNumber">-</p>
            </div>

            <!-- Client Info -->
            <div class="glass-card">
                <h3 class="section-title">üë§ Informations Client</h3>
                
                <div class="form-group">
                    <label class="form-label">Nom du Client</label>
                    <input type="text" id="clientName" class="form-input" placeholder="Nom complet">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Adresse Compl√®te</label>
                    <input type="text" id="clientAddress" class="form-input" placeholder="Num√©ro, rue, ville, code postal">
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Date d'Arriv√©e</label>
                        <input type="date" id="arrivalDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Heure d'Arriv√©e</label>
                        <input type="time" id="arrivalTime" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Nature de l'intervention -->
            <div class="glass-card">
                <h3 class="section-title">üîß Nature de l'Intervention</h3>
                <div class="form-group">
                    <select id="natureIntervention" class="form-input">
                        <option value="">-- S√©lectionner le type d'intervention --</option>
                        <option value="Fuite">Fuite</option>
                        <option value="D√©pannage">D√©pannage</option>
                        <option value="Entretien annuel">Entretien annuel</option>
                        <option value="Entretien trimestriel">Entretien trimestriel</option>
                        <option value="VMC">VMC</option>
                        <option value="Diagnostic">Diagnostic</option>
                    </select>
                </div>
            </div>

            <!-- Description -->
            <div class="glass-card">
                <h3 class="section-title">üìù Description</h3>
                <div class="form-group">
                    <textarea id="description" rows="5" class="form-textarea" placeholder="Description d√©taill√©e de l'intervention r√©alis√©e..."></textarea>
                </div>
            </div>

            <!-- Observations -->
            <div class="glass-card">
                <h3 class="section-title">üí¨ Observations</h3>
                <div class="form-group">
                    <textarea id="observations" rows="4" class="form-textarea" placeholder="Notes compl√©mentaires, recommandations, points d'attention..."></textarea>
                </div>
            </div>

            <!-- Photos -->
            <div class="glass-card">
                <h3 class="section-title">üì∏ Photos</h3>
                <div class="form-group">
                    <input type="file" accept="image/*" multiple id="photoInput" style="display:none">
                    <button type="button" onclick="document.getElementById('photoInput').click()" class="btn btn-secondary" style="width:100%">
                        üì∑ Ajouter des photos
                    </button>
                </div>
                <div id="photosList" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:10px;">
                </div>
            </div>

            <!-- Signature -->
            <div class="glass-card">
                <h3 class="section-title">‚úçÔ∏è Signature du Client</h3>
                
                <div class="form-group">
                    <label class="form-label">Nom du signataire</label>
                    <input type="text" id="signatureName" class="form-input" placeholder="Nom complet de la personne qui signe">
                </div>
                
                <div class="signature-container">
                    <canvas id="signatureCanvas" class="signature-canvas" height="60"></canvas>
                </div>
                <div class="grid-2">
                    <button onclick="clearSignature()" class="btn btn-secondary">
                        üîÑ Effacer
                    </button>
                    <button onclick="saveSignature()" class="btn btn-success">
                        ‚úÖ Valider
                    </button>
                </div>
                <p id="signatureStatus" class="signature-status"></p>
            </div>

            <!-- Generate Button -->
            <button onclick="generatePDF()" class="btn btn-primary">
                üì• Valider et T√©l√©charger le PDF
            </button>
        </div>

        <!-- History Tab -->
        <div id="content-history" class="tab-content">
            <div class="glass-card">
                <h2 class="section-title">üìã Historique des Bons</h2>
                <div id="history-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let profile = JSON.parse(localStorage.getItem('company_profile') || 'null');
        let history = JSON.parse(localStorage.getItem('bons_history') || '[]');
        let bonCounter = JSON.parse(localStorage.getItem('bon_counter') || '{"year": 0, "month": 0, "count": 0}');
        let interventions = [];
        let photos = [];
        let signatureData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('arrivalDate').value = today;
            
            if (profile) {
                document.getElementById('companyName').value = profile.companyName || '';
                document.getElementById('siren').value = profile.siren || '';
                document.getElementById('technicianName').value = profile.technicianName || '';
            }
            
            initSignatureCanvas();
            addIntervention();
            updateNextBonNumber();
            switchTab('new-bon');
            updateHistoryDisplay();
            
            // Photos - APR√àS que le DOM soit charg√©
            document.getElementById('photoInput').onchange = function(e) {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        photos.push(ev.target.result);
                        showPhotos();
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            };
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('content-' + tabName).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Profile
        function saveProfile() {
            profile = {
                companyName: document.getElementById('companyName').value,
                siren: document.getElementById('siren').value,
                technicianName: document.getElementById('technicianName').value,
                logo: null
            };
            
            localStorage.setItem('company_profile', JSON.stringify(profile));
            
            const msg = document.getElementById('profileMessage');
            msg.textContent = '‚úÖ Profil enregistr√© avec succ√®s !';
            msg.className = 'message success';
            
            setTimeout(() => msg.className = 'message hidden', 3000);
        }

        // Interventions
        function addIntervention() {
            interventions.push('');
            renderInterventions();
        }

        function removeIntervention(index) {
            if (interventions.length > 1) {
                interventions.splice(index, 1);
                renderInterventions();
            }
        }

        function updateIntervention(index, value) {
            interventions[index] = value;
        }

        function renderInterventions() {
            const container = document.getElementById('interventions-container');
            if (!container) return; // Fix l'erreur
            container.innerHTML = '';
            
            interventions.forEach((value, index) => {
                const div = document.createElement('div');
                div.className = 'intervention-item';
                div.innerHTML = `
                    <div class="intervention-header">
                        <span class="intervention-label">Intervention #${index + 1}</span>
                        ${interventions.length > 1 ? `
                            <button onclick="removeIntervention(${index})" class="btn btn-danger">
                                üóëÔ∏è Supprimer
                            </button>
                        ` : ''}
                    </div>
                    <textarea 
                        onchange="updateIntervention(${index}, this.value)"
                        rows="3" 
                        class="form-textarea"
                        placeholder="D√©crivez en d√©tail l'intervention r√©alis√©e..."
                    >${value}</textarea>
                `;
                container.appendChild(div);
            });
        }

        function showPhotos() {
            const list = document.getElementById('photosList');
            if (!list) return;
            if (!photos || photos.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 0; i < photos.length; i++) {
                html += '<div style="position:relative">';
                html += '<img src="' + photos[i] + '" style="width:100%; height:120px; object-fit:cover; border-radius:8px">';
                html += '<button onclick="removePhoto(' + i + ')" style="position:absolute; top:5px; right:5px; background:#ef4444; color:white; border:none; width:25px; height:25px; border-radius:50%; cursor:pointer">√ó</button>';
                html += '</div>';
            }
            list.innerHTML = html;
        }
        
        function removePhoto(index) {
            photos.splice(index, 1);
            showPhotos();
        }

        // Signature
        function initSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Set canvas size properly
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth - 16; // Account for padding
            canvas.height = 60; // Ultra compact pour mobile
            
            // Fill white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            let drawing = false;
            let lastX = 0, lastY = 0;

            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches && e.touches.length > 0) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                } else {
                    return {
                        x: (e.clientX - rect.left) * scaleX,
                        y: (e.clientY - rect.top) * scaleY
                    };
                }
            }

            function start(e) {
                e.preventDefault();
                drawing = true;
                const coords = getCoordinates(e);
                lastX = coords.x;
                lastY = coords.y;
                
                // Draw a dot for single taps
                ctx.beginPath();
                ctx.arc(lastX, lastY, 1, 0, Math.PI * 2);
                ctx.fillStyle = '#000';
                ctx.fill();
            }

            function draw(e) {
                if (!drawing) return;
                e.preventDefault();
                
                const coords = getCoordinates(e);
                
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                
                lastX = coords.x;
                lastY = coords.y;
            }

            function stop(e) {
                if (drawing) {
                    e.preventDefault();
                    drawing = false;
                }
            }

            // Mouse events
            canvas.addEventListener('mousedown', start, { passive: false });
            canvas.addEventListener('mousemove', draw, { passive: false });
            canvas.addEventListener('mouseup', stop, { passive: false });
            canvas.addEventListener('mouseleave', stop, { passive: false });
            
            // Touch events
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop, { passive: false });
            canvas.addEventListener('touchcancel', stop, { passive: false });
        }

        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear and fill white
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            signatureData = null;
            document.getElementById('signatureStatus').textContent = '';
            document.getElementById('signatureStatus').classList.remove('saved');
        }

        function saveSignature() {
            const canvas = document.getElementById('signatureCanvas');
            signatureData = canvas.toDataURL('image/png');
            const status = document.getElementById('signatureStatus');
            status.textContent = '‚úÖ Signature enregistr√©e';
            status.classList.add('saved');
        }

        // Bon numbers
        function getNextBonNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            
            if (bonCounter.year !== year || bonCounter.month !== month) {
                bonCounter = { year, month, count: 1 };
            } else {
                bonCounter.count++;
            }
            
            localStorage.setItem('bon_counter', JSON.stringify(bonCounter));
            return year.toString() + month.toString().padStart(2, '0') + bonCounter.count.toString();
        }

        function updateNextBonNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            
            let count = bonCounter.count;
            if (bonCounter.year !== year || bonCounter.month !== month) {
                count = 1;
            } else {
                count = bonCounter.count + 1;
            }
            
            const preview = year.toString() + month.toString().padStart(2, '0') + count.toString();
            document.getElementById('nextBonNumber').textContent = 'N¬∞ ' + preview;
        }

        // PDF Generation - 1 SEULE PAGE
        async function generatePDF() {
            // V√©rifier que jsPDF est charg√©
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert("‚ùå Erreur: jsPDF n'est pas charg√©.\n\nLe script CDN est peut-√™tre bloqu√©.\n\nSolution: Ouvrez la page dans un onglet normal ou mettez-la en ligne sur Netlify.");
                console.error("jspdf missing:", window.jspdf);
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const bonNumber = getNextBonNumber();
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const arrivalDate = document.getElementById('arrivalDate').value;
            const arrivalTime = document.getElementById('arrivalTime').value;
            const natureIntervention = document.getElementById('natureIntervention').value;
            const description = document.getElementById('description').value;
            const observations = document.getElementById('observations').value;
            const signatureName = document.getElementById('signatureName').value;
            
            let sig = signatureData;
            if (!sig) {
                const tc = document.createElement('canvas');
                tc.width = 400;
                tc.height = 100;
                const tctx = tc.getContext('2d');
                tctx.fillStyle = '#cbd5e0';
                tctx.font = 'italic 18px Arial';
                tctx.textAlign = 'center';
                tctx.textBaseline = 'middle';
                tctx.fillText('(Signature non renseign√©e)', 200, 50);
                sig = tc.toDataURL('image/png');
            }
            
            let yPos = 0;
            
            // Couleurs
            const darkBlue = [15, 76, 92];
            
            // Fond beige
            doc.setFillColor(245, 245, 240);
            doc.rect(0, 0, 210, 297, 'F');
            
            // Vague bleue en haut
            doc.setFillColor(...darkBlue);
            doc.moveTo(0, 0);
            doc.lineTo(210, 0);
            doc.lineTo(210, 60);
            for (let x = 210; x >= 0; x -= 10) {
                const y = 60 + Math.sin((x / 210) * Math.PI) * 20;
                doc.lineTo(x, y);
            }
            doc.lineTo(0, 0);
            doc.fill();
            
            // Titre
            yPos = 25;
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text("Fiche d'interventions", 120, yPos);
            
            yPos = 45;
            doc.setFontSize(36);
            doc.text(`N¬∞ ${bonNumber}`, 120, yPos);
            
            // Infos gauche
            yPos = 95;
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            let leftY = yPos;
            doc.text('Date et heure de d√©but :', 20, leftY);
            leftY += 4;
            doc.setFont('helvetica', 'bold');
            if (arrivalDate && arrivalTime) {
                doc.text(`${new Date(arrivalDate).toLocaleDateString('fr-FR')} ${arrivalTime}`, 20, leftY);
            } else if (arrivalDate) {
                doc.text(new Date(arrivalDate).toLocaleDateString('fr-FR'), 20, leftY);
            }
            leftY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.text('Date et heure de fin :', 20, leftY);
            leftY += 4;
            doc.text('_____________________', 20, leftY);
            leftY += 6;
            
            doc.text('Intervenant :', 20, leftY);
            leftY += 4;
            doc.setFont('helvetica', 'bold');
            doc.text(profile?.technicianName || '', 20, leftY);
            
            // Infos droite
            let rightY = yPos;
            doc.setFont('helvetica', 'normal');
            doc.text('Nom du client :', 120, rightY);
            rightY += 4;
            doc.setFont('helvetica', 'bold');
            doc.text(clientName || '', 120, rightY);
            rightY += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.text('Adresse :', 120, rightY);
            rightY += 4;
            if (clientAddress) {
                const addrLines = doc.splitTextToSize(clientAddress, 70);
                doc.text(addrLines, 120, rightY);
            }
            
            // Nature intervention (petite bo√Æte)
            yPos = 135;
            doc.setFillColor(...darkBlue);
            doc.rect(20, yPos, 80, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Nature de l'intervention", 22, yPos + 5.5);
            
            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(...darkBlue);
            doc.setLineWidth(0.5);
            doc.rect(20, yPos + 8, 80, 25, 'FD');
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            if (natureIntervention) {
                const natLines = doc.splitTextToSize(natureIntervention, 75);
                doc.text(natLines, 22, yPos + 12);
            }
            
            // Observations (petite bo√Æte)
            doc.setFillColor(...darkBlue);
            doc.rect(110, yPos, 80, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text("Observations", 112, yPos + 5.5);
            
            doc.setFillColor(255, 255, 255);
            doc.rect(110, yPos + 8, 80, 25, 'FD');
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            if (observations) {
                const obsLines = doc.splitTextToSize(observations, 75);
                doc.text(obsLines, 112, yPos + 12);
            }
            
            // Description (bo√Æte plus grande)
            yPos = 173;
            doc.setFillColor(...darkBlue);
            doc.rect(20, yPos, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Description", 22, yPos + 5.5);
            
            doc.setFillColor(255, 255, 255);
            doc.rect(20, yPos + 8, 170, 45, 'FD');
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            if (description) {
                const descLines = doc.splitTextToSize(description, 165);
                doc.text(descLines, 22, yPos + 12);
            }
            
            // PHOTOS - EN BAS DE PAGE 1 si possible
            yPos = 230; // Position apr√®s description
            
            if (photos && photos.length > 0) {
                // Photos en bas de la page 1 (max 2)
                const photosPage1 = Math.min(photos.length, 2);
                
                for (let i = 0; i < photosPage1; i++) {
                    const col = i % 2;
                    const x = col === 0 ? 20 : 115;
                    const y = yPos;
                    
                    try {
                        doc.addImage(photos[i], 'JPEG', x, y, 85, 64);
                        doc.setDrawColor(...darkBlue);
                        doc.setLineWidth(0.5);
                        doc.rect(x, y, 85, 64);
                    } catch (e) {
                        console.log('Erreur photo', e);
                    }
                }
                
                // Si plus de 2 photos, continuer sur page 2
                if (photos.length > 2) {
                    doc.addPage();
                    doc.setFillColor(245, 245, 240);
                    doc.rect(0, 0, 210, 297, 'F');
                    
                    yPos = 20;
                    doc.setTextColor(...darkBlue);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Photos (suite)', 105, yPos, { align: 'center' });
                    yPos = 35;
                    
                    for (let i = 2; i < photos.length; i++) {
                        const col = (i - 2) % 2;
                        const row = Math.floor((i - 2) / 2);
                        const x = col === 0 ? 20 : 115;
                        const y = yPos + (row * 74);
                        
                        if (y > 220) {
                            doc.addPage();
                            doc.setFillColor(245, 245, 240);
                            doc.rect(0, 0, 210, 297, 'F');
                            yPos = 20;
                        }
                        
                        try {
                            doc.addImage(photos[i], 'JPEG', x, y, 85, 64);
                            doc.setDrawColor(...darkBlue);
                            doc.setLineWidth(0.5);
                            doc.rect(x, y, 85, 64);
                        } catch (e) {
                            console.log('Erreur photo', e);
                        }
                    }
                }
                
                // Signature sur nouvelle page (toujours propre)
                doc.addPage();
                doc.setFillColor(245, 245, 240);
                doc.rect(0, 0, 210, 297, 'F');
                yPos = 100;
            } else {
                // Pas de photos, signature sur nouvelle page quand m√™me
                doc.addPage();
                doc.setFillColor(245, 245, 240);
                doc.rect(0, 0, 210, 297, 'F');
                yPos = 100;
            }
            
            // SIGNATURE
            doc.setTextColor(...darkBlue);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Signature du Client', 105, yPos, { align: 'center' });
            
            yPos += 20;
            doc.setDrawColor(...darkBlue);
            doc.setLineWidth(0.8);
            doc.rect(60, yPos, 90, 40, 'D');
            
            if (sig) {
                doc.addImage(sig, 'PNG', 63, yPos + 5, 84, 30);
            }
            
            yPos += 50;
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 105, yPos, { align: 'center' });
            yPos += 5;
            doc.text(`Nom: ${signatureName || clientName || '___________________'}`, 105, yPos, { align: 'center' });
            
            // Save - M√©thode compatible tous navigateurs
            try {
                // G√©n√©rer le blob du PDF
                const pdfBlob = doc.output('blob');
                
                // Cr√©er un lien de t√©l√©chargement
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Fiche_Intervention_${bonNumber}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ PDF g√©n√©r√© avec succ√®s !');
            } catch (e) {
                alert('Erreur lors de la g√©n√©ration du PDF: ' + e.message);
                console.error('Erreur PDF:', e);
                return;
            }
            
            // History
            const item = {
                bonNumber,
                clientName,
                clientAddress,
                arrivalDate,
                arrivalTime,
                natureIntervention,
                description,
                observations,
                signatureName,
                signatureData: sig,
                createdAt: new Date().toISOString(),
                companyProfile: profile
            };
            
            history.unshift(item);
            history = history.slice(0, 20);
            localStorage.setItem('bons_history', JSON.stringify(history));
            
            // Reset
            document.getElementById('clientName').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('arrivalTime').value = '';
            document.getElementById('natureIntervention').value = '';
            document.getElementById('description').value = '';
            document.getElementById('observations').value = '';
            document.getElementById('signatureName').value = '';
            interventions = [];
            photos = [];
            addIntervention();
            showPhotos();
            clearSignature();
            updateNextBonNumber();
            updateHistoryDisplay();
            
            alert('‚úÖ PDF g√©n√©r√© avec succ√®s !');
        }

        // History
        function updateHistoryDisplay() {
            const list = document.getElementById('history-list');
            
            if (history.length === 0) {
                list.innerHTML = '<div class="empty-state">Aucun bon enregistr√©</div>';
                return;
            }
            
            list.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        <div>
                            <div class="history-bon">N¬∞ ${item.bonNumber}</div>
                            <div class="history-client">${item.clientName || ''}</div>
                        </div>
                        <div class="history-date">${new Date(item.createdAt).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div class="history-address">${item.clientAddress || ''}</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
