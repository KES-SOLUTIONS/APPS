<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KES Solutions - Bons d'Intervention</title>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #ffffff;
      padding: 20px;
    }

    .container { max-width: 900px; margin: 0 auto; }

    .header { text-align: center; margin-bottom: 36px; position: relative; }

    .header h1 { font-size: 2.3rem; font-weight: 900; color: #0099ff; margin-bottom: 8px; }
    .header .subtitle { color: #9ca3af; font-size: 0.875rem; }
    .header .tagline { color: #6b7280; font-size: 0.75rem; margin-top: 8px; }

    .logout-btn {
      position: absolute; right: 0; top: 6px;
      background: #374151; color: #d1d5db;
      border: none; cursor: pointer;
      padding: 10px 14px; border-radius: 12px;
      font-weight: 800; font-size: 0.85rem;
      transition: .2s;
    }
    .logout-btn:hover { background: #4b5563; color: #ffffff; }

    .user-badge {
      position: absolute; left: 0; top: 10px;
      color: #9ca3af; font-size: 0.85rem; font-weight: 800;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 18px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .tab-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 0.875rem;
      white-space: nowrap;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: #374151;
      color: #d1d5db;
    }

    .tab-btn.active { background: #0099ff; color: #ffffff; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 22px;
      margin-bottom: 18px;
    }

    .section-title {
      font-size: 1.12rem;
      font-weight: 900;
      color: #0099ff;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 800;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid #374151;
      color: #ffffff;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #0099ff;
      box-shadow: 0 0 0 3px rgba(0, 153, 255, 0.1);
    }

    .form-input::placeholder,
    .form-textarea::placeholder { color: #6b7280; }

    .form-textarea { resize: vertical; font-family: inherit; }

    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: #0099ff;
      color: #ffffff;
      width: 100%;
      padding: 16px;
      font-size: 1rem;
      box-shadow: 0 4px 24px rgba(0, 153, 255, 0.35);
    }
    .btn-primary:hover { background: #0088ee; }

    .btn-secondary { background: #374151; color: #d1d5db; }
    .btn-secondary:hover { background: #4b5563; color: #ffffff; }

    .btn-success { background: #10b981; color: #ffffff; }
    .btn-success:hover { background: #059669; }

    .btn-danger {
      background: transparent;
      color: #ef4444;
      font-size: 0.75rem;
      padding: 4px 8px;
    }
    .btn-danger:hover { text-decoration: underline; }

    .preview-card { text-align: center; padding: 18px; }
    .preview-label { font-size: 0.875rem; color: #9ca3af; margin-bottom: 8px; }
    .preview-number { font-size: 2rem; font-weight: 950; color: #0099ff; }

    .intervention-item { margin-bottom: 14px; }
    .intervention-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .intervention-label { font-size: 0.75rem; font-weight: 900; color: #0099ff; }

    .signature-container { background: #ffffff; border-radius: 12px; padding: 4px; margin-bottom: 12px; }
    .signature-canvas {
      border: 2px dashed #0099ff;
      background: #ffffff;
      cursor: crosshair;
      touch-action: none;
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    .signature-status { text-align: center; font-size: 0.875rem; color: #9ca3af; margin-top: 8px; }
    .signature-status.saved { color: #10b981; }

    .history-item {
      background: rgba(31, 41, 55, 0.5);
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .history-bon { font-size: 1.125rem; font-weight: 950; color: #0099ff; }
    .history-client { font-size: 0.875rem; color: #9ca3af; margin-top: 4px; }
    .history-date { font-size: 0.75rem; color: #6b7280; }
    .history-address { font-size: 0.875rem; color: #d1d5db; margin-bottom: 8px; }
    .history-meta { font-size: 0.75rem; color: #6b7280; }

    .message { padding: 12px; border-radius: 12px; margin-top: 16px; text-align: center; }
    .message.success { background: #10b981; color: #ffffff; }
    .message.hidden { display: none; }

    .empty-state { text-align: center; padding: 42px 20px; color: #6b7280; font-size: 0.875rem; }

    @media (max-width: 640px) {
      .header h1 { font-size: 2rem; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .glass-card { padding: 16px; }
      .logout-btn { position: static; width: 100%; margin-top: 14px; }
      .user-badge { position: static; display: block; margin-bottom: 10px; }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="header">
      <div class="user-badge" id="userBadge"></div>
      <button class="logout-btn" type="button" onclick="logout()">üö™ D√©connexion</button>

      <h1>KES SOLUTIONS</h1>
      <p class="subtitle">KOPILOTS ENERGIE SYSTEME</p>
      <p class="tagline">Gestion des Bons d'Intervention</p>
    </div>

    <div class="tabs">
      <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')">üë§ Profil</button>
      <button class="tab-btn" id="tab-new-bon" onclick="switchTab('new-bon')">‚ûï Nouveau Bon</button>
      <button class="tab-btn" id="tab-history" onclick="switchTab('history')">üìã Historique</button>
    </div>

    <!-- Profile -->
    <div id="content-profile" class="tab-content">
      <div class="glass-card">
        <h2 class="section-title">üë§ Informations de l'Entreprise</h2>

        <div class="form-group">
          <label class="form-label">Nom de l'Entreprise</label>
          <input type="text" id="companyName" class="form-input" placeholder="KES SOLUTIONS">
        </div>

        <div class="form-group">
          <label class="form-label">SIREN</label>
          <input type="text" id="siren" class="form-input" placeholder="123 456 789">
        </div>

        <div class="form-group">
          <label class="form-label">Nom du Technicien</label>
          <input type="text" id="technicianName" class="form-input" placeholder="Nom Pr√©nom">
        </div>

        <button onclick="saveProfile()" class="btn btn-primary">üíæ Enregistrer le Profil</button>
        <div id="profileMessage" class="message hidden"></div>
      </div>
    </div>

    <!-- New Bon -->
    <div id="content-new-bon" class="tab-content">
      <div class="glass-card preview-card">
        <p class="preview-label">Prochain Bon d'Intervention</p>
        <p class="preview-number" id="nextBonNumber">-</p>
      </div>

      <div class="glass-card">
        <h3 class="section-title">üë§ Informations Client</h3>

        <div class="form-group">
          <label class="form-label">Nom du Client</label>
          <input type="text" id="clientName" class="form-input" placeholder="Nom complet">
        </div>

        <div class="form-group">
          <label class="form-label">Adresse Compl√®te</label>
          <input type="text" id="clientAddress" class="form-input" placeholder="Num√©ro, rue, ville, code postal">
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label class="form-label">Date d'Arriv√©e</label>
            <input type="date" id="arrivalDate" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Heure d'Arriv√©e</label>
            <input type="time" id="arrivalTime" class="form-input">
          </div>
        </div>
      </div>

      <div class="glass-card">
        <h3 class="section-title">üîß Nature de l'Intervention</h3>
        <div class="form-group">
          <select id="natureIntervention" class="form-input">
            <option value="">-- S√©lectionner le type d'intervention --</option>
            <option value="Fuite">Fuite</option>
            <option value="D√©pannage">D√©pannage</option>
            <option value="Entretien annuel">Entretien annuel</option>
            <option value="Entretien trimestriel">Entretien trimestriel</option>
            <option value="VMC">VMC</option>
            <option value="Diagnostic">Diagnostic</option>
          </select>
        </div>
      </div>

      <div class="glass-card">
        <h3 class="section-title">üß∞ Interventions (d√©tail)</h3>
        <div id="interventions-container"></div>
        <button class="btn btn-secondary" type="button" onclick="addIntervention()">‚ûï Ajouter une intervention</button>
      </div>

      <div class="glass-card">
        <h3 class="section-title">üìù Description</h3>
        <div class="form-group">
          <textarea id="description" rows="5" class="form-textarea" placeholder="Description d√©taill√©e..."></textarea>
        </div>
      </div>

      <div class="glass-card">
        <h3 class="section-title">üí¨ Observations</h3>
        <div class="form-group">
          <textarea id="observations" rows="4" class="form-textarea" placeholder="Notes compl√©mentaires..."></textarea>
        </div>
      </div>

      <div class="glass-card">
        <h3 class="section-title">‚úçÔ∏è Signature du Client</h3>

        <div class="form-group">
          <label class="form-label">Nom du signataire</label>
          <input type="text" id="signatureName" class="form-input" placeholder="Nom complet">
        </div>

        <div class="signature-container">
          <canvas id="signatureCanvas" class="signature-canvas" height="60"></canvas>
        </div>

        <div class="grid-2">
          <button onclick="clearSignature()" class="btn btn-secondary" type="button">üîÑ Effacer</button>
          <button onclick="saveSignature()" class="btn btn-success" type="button">‚úÖ Valider</button>
        </div>

        <p id="signatureStatus" class="signature-status"></p>
      </div>

      <button onclick="generatePDF()" class="btn btn-primary">üì• Valider et T√©l√©charger le PDF</button>
    </div>

    <!-- History -->
    <div id="content-history" class="tab-content">
      <div class="glass-card">
        <h2 class="section-title">üìã Historique des Bons</h2>
        <div id="history-list"></div>
      </div>
    </div>

  </div>

  <script>
    /***********************
     * AUTH GUARD
     ***********************/
    function getUser() {
      try { return JSON.parse(localStorage.getItem("kes_user") || "null"); }
      catch(e) { return null; }
    }

    function ensureAuthOrRedirect() {
      const u = getUser();
      if (!u || !u.email) {
        window.location.href = "login.html";
        return false;
      }
      return true;
    }

    function logout() {
      localStorage.removeItem("kes_user");
      window.location.href = "login.html";
    }

    /***********************
     * State
     ***********************/
    let profile = JSON.parse(localStorage.getItem('company_profile') || 'null');
    let history = JSON.parse(localStorage.getItem('bons_history') || '[]');
    let bonCounter = JSON.parse(localStorage.getItem('bon_counter') || '{"year": 0, "month": 0, "count": 0}');
    let interventions = [];
    let signatureData = null;

    document.addEventListener('DOMContentLoaded', function() {
      if (!ensureAuthOrRedirect()) return;

      const u = getUser();
      const badge = document.getElementById("userBadge");
      badge.textContent = u?.name ? `Connect√© : ${u.name}` : `Connect√© : ${u.email}`;

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('arrivalDate').value = today;

      if (profile) {
        document.getElementById('companyName').value = profile.companyName || '';
        document.getElementById('siren').value = profile.siren || '';
        document.getElementById('technicianName').value = profile.technicianName || '';
      }

      initSignatureCanvas();
      addIntervention();
      updateNextBonNumber();
      switchTab('new-bon');
      updateHistoryDisplay();
    });

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      document.getElementById('content-' + tabName).classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    function saveProfile() {
      profile = {
        companyName: document.getElementById('companyName').value.trim(),
        siren: document.getElementById('siren').value.trim(),
        technicianName: document.getElementById('technicianName').value.trim(),
        logo: null
      };
      localStorage.setItem('company_profile', JSON.stringify(profile));

      const msg = document.getElementById('profileMessage');
      msg.textContent = '‚úÖ Profil enregistr√© avec succ√®s !';
      msg.className = 'message success';
      setTimeout(() => msg.className = 'message hidden', 2500);
    }

    /***********************
     * Interventions
     ***********************/
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function addIntervention() {
      interventions.push('');
      renderInterventions();
    }

    function removeIntervention(index) {
      if (interventions.length > 1) {
        interventions.splice(index, 1);
        renderInterventions();
      }
    }

    function updateIntervention(index, value) {
      interventions[index] = value;
    }

    function renderInterventions() {
      const container = document.getElementById('interventions-container');
      if (!container) return;
      container.innerHTML = '';

      interventions.forEach((value, index) => {
        const div = document.createElement('div');
        div.className = 'intervention-item';
        div.innerHTML = `
          <div class="intervention-header">
            <span class="intervention-label">Intervention #${index + 1}</span>
            ${interventions.length > 1 ? `
              <button type="button" onclick="removeIntervention(${index})" class="btn btn-danger">üóëÔ∏è Supprimer</button>
            ` : ''}
          </div>
          <textarea
            onchange="updateIntervention(${index}, this.value)"
            rows="3"
            class="form-textarea"
            placeholder="D√©crivez en d√©tail..."
          >${escapeHtml(value)}</textarea>
        `;
        container.appendChild(div);
      });
    }

    /***********************
     * Signature
     ***********************/
    function initSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const container = canvas.parentElement;

      canvas.width = container.offsetWidth - 16;
      canvas.height = 60;

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      let drawing = false;
      let lastX = 0, lastY = 0;

      function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        if (e.touches && e.touches.length > 0) {
          return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
        }
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
      }

      function start(e) {
        e.preventDefault();
        drawing = true;
        const c = getCoordinates(e);
        lastX = c.x; lastY = c.y;
        ctx.beginPath();
        ctx.arc(lastX, lastY, 1, 0, Math.PI * 2);
        ctx.fillStyle = '#000';
        ctx.fill();
      }

      function draw(e) {
        if (!drawing) return;
        e.preventDefault();

        const c = getCoordinates(e);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(c.x, c.y);
        ctx.stroke();

        lastX = c.x; lastY = c.y;
      }

      function stop(e) {
        if (!drawing) return;
        e.preventDefault();
        drawing = false;
      }

      canvas.addEventListener('mousedown', start, { passive: false });
      canvas.addEventListener('mousemove', draw, { passive: false });
      canvas.addEventListener('mouseup', stop, { passive: false });
      canvas.addEventListener('mouseleave', stop, { passive: false });

      canvas.addEventListener('touchstart', start, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', stop, { passive: false });
      canvas.addEventListener('touchcancel', stop, { passive: false });
    }

    function clearSignature() {
      const canvas = document.getElementById('signatureCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      signatureData = null;
      const status = document.getElementById('signatureStatus');
      status.textContent = '';
      status.classList.remove('saved');
    }

    function saveSignature() {
      const canvas = document.getElementById('signatureCanvas');
      if (!canvas) return;

      signatureData = canvas.toDataURL('image/png');
      const status = document.getElementById('signatureStatus');
      status.textContent = '‚úÖ Signature enregistr√©e';
      status.classList.add('saved');
    }

    /***********************
     * Bon numbering
     ***********************/
    function getNextBonNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      if (bonCounter.year !== year || bonCounter.month !== month) {
        bonCounter = { year, month, count: 1 };
      } else {
        bonCounter.count++;
      }

      localStorage.setItem('bon_counter', JSON.stringify(bonCounter));
      return year.toString() + String(month).padStart(2, '0') + String(bonCounter.count);
    }

    function updateNextBonNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      let count = bonCounter.count;
      if (bonCounter.year !== year || bonCounter.month !== month) count = 1;
      else count = bonCounter.count + 1;

      const preview = year.toString() + String(month).padStart(2, '0') + String(count);
      document.getElementById('nextBonNumber').textContent = 'N¬∞ ' + preview;
    }

    /***********************
     * PDF generation
     ***********************/
    async function generatePDF() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("jsPDF n'est pas charg√©. V√©rifie ton r√©seau.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const bonNumber = getNextBonNumber();
      const clientName = document.getElementById('clientName').value.trim();
      const clientAddress = document.getElementById('clientAddress').value.trim();
      const arrivalDate = document.getElementById('arrivalDate').value;
      const arrivalTime = document.getElementById('arrivalTime').value;
      const natureIntervention = document.getElementById('natureIntervention').value;
      const description = document.getElementById('description').value.trim();
      const observations = document.getElementById('observations').value.trim();
      const signatureName = document.getElementById('signatureName').value.trim();

      // Signature placeholder si pas sign√©e
      let sig = signatureData;
      if (!sig) {
        const tc = document.createElement('canvas');
        tc.width = 400; tc.height = 100;
        const tctx = tc.getContext('2d');
        tctx.fillStyle = '#f3f4f6';
        tctx.fillRect(0,0,tc.width,tc.height);
        tctx.fillStyle = '#6b7280';
        tctx.font = 'italic 18px Arial';
        tctx.textAlign = 'center';
        tctx.textBaseline = 'middle';
        tctx.fillText('(Signature non renseign√©e)', 200, 50);
        sig = tc.toDataURL('image/png');
      }

      // --- PDF style simple & clean
      doc.setFillColor(245,245,240);
      doc.rect(0, 0, 210, 297, 'F');

      doc.setTextColor(0, 153, 255);
      doc.setFont('helvetica','bold');
      doc.setFontSize(22);
      doc.text("Fiche d'intervention", 20, 20);

      doc.setTextColor(20,20,20);
      doc.setFontSize(12);
      doc.text(`Bon N¬∞ ${bonNumber}`, 20, 30);

      doc.setFont('helvetica','normal');
      doc.setFontSize(10);
      doc.text(`Client: ${clientName}`, 20, 42);
      doc.text(`Adresse: ${clientAddress}`, 20, 48);

      let y = 60;
      doc.setFont('helvetica','bold');
      doc.text("Infos", 20, y);
      y += 6;
      doc.setFont('helvetica','normal');
      doc.text(`Arriv√©e: ${arrivalDate ? new Date(arrivalDate).toLocaleDateString('fr-FR') : ''} ${arrivalTime || ''}`, 20, y);
      y += 6;
      doc.text(`Intervenant: ${(profile && profile.technicianName) ? profile.technicianName : ''}`, 20, y);
      y += 10;

      doc.setFont('helvetica','bold');
      doc.text("Nature", 20, y); y += 6;
      doc.setFont('helvetica','normal');
      doc.text(doc.splitTextToSize(natureIntervention || '', 170), 20, y);
      y += 12;

      doc.setFont('helvetica','bold');
      doc.text("Description", 20, y); y += 6;
      doc.setFont('helvetica','normal');
      doc.text(doc.splitTextToSize(description || '', 170), 20, y);
      y += 18;

      doc.setFont('helvetica','bold');
      doc.text("Observations", 20, y); y += 6;
      doc.setFont('helvetica','normal');
      doc.text(doc.splitTextToSize(observations || '', 170), 20, y);
      y += 24;

      doc.setFont('helvetica','bold');
      doc.text("Signature", 20, 230);
      doc.setDrawColor(0,153,255);
      doc.rect(20, 235, 170, 35);
      doc.addImage(sig, 'PNG', 22, 237, 166, 31);

      doc.setFont('helvetica','normal');
      doc.setFontSize(9);
      doc.text(`Nom: ${signatureName || clientName || '___________________'}`, 20, 280);
      doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, 150, 280);

      doc.save(`Fiche_Intervention_${bonNumber}.pdf`);

      // ‚úÖ Save history with interventions
      const item = {
        bonNumber,
        clientName,
        clientAddress,
        arrivalDate,
        arrivalTime,
        natureIntervention,
        description,
        observations,
        signatureName,
        signatureData: sig,
        interventions: [...interventions],
        createdAt: new Date().toISOString(),
        companyProfile: profile
      };

      history.unshift(item);
      history = history.slice(0, 30);
      localStorage.setItem('bons_history', JSON.stringify(history));

      // Reset form => nouveau bon vide
      document.getElementById('clientName').value = '';
      document.getElementById('clientAddress').value = '';
      document.getElementById('arrivalTime').value = '';
      document.getElementById('natureIntervention').value = '';
      document.getElementById('description').value = '';
      document.getElementById('observations').value = '';
      document.getElementById('signatureName').value = '';

      interventions = [];
      addIntervention();
      clearSignature();
      updateNextBonNumber();
      updateHistoryDisplay();

      alert('‚úÖ Bon enregistr√© + PDF t√©l√©charg√©.');
    }

    /***********************
     * History UI
     ***********************/
    function updateHistoryDisplay() {
      const list = document.getElementById('history-list');

      if (!history || history.length === 0) {
        list.innerHTML = '<div class="empty-state">Aucun bon enregistr√©</div>';
        return;
      }

      list.innerHTML = history.map(item => `
        <div class="history-item">
          <div class="history-header">
            <div>
              <div class="history-bon">N¬∞ ${item.bonNumber || ''}</div>
              <div class="history-client">${item.clientName || ''}</div>
            </div>
            <div class="history-date">${item.createdAt ? new Date(item.createdAt).toLocaleDateString('fr-FR') : ''}</div>
          </div>
          <div class="history-address">${item.clientAddress || ''}</div>
          <div class="history-meta">${(item.interventions || []).length} intervention(s)</div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
