<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Bons d'Intervention</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%);
            min-height: 100vh;
            padding: 30px;
            font-size: 18px; /* Police de base 18px comme demand√© */
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        /* Navigation principale */
        .main-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 4px solid #e2e8f0;
            padding: 0 30px;
        }

        .main-tab {
            padding: 24px 40px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.15em;
            font-weight: 700;
            color: #64748b;
            border-bottom: 4px solid transparent;
            margin-bottom: -4px;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .main-tab:hover {
            color: #1e3a5f;
            background: rgba(30, 58, 95, 0.05);
        }

        .main-tab.active {
            color: #1e3a5f;
            border-bottom-color: #1e3a5f;
            background: #ffffff;
        }

        .tab-panel {
            display: none;
            padding: 50px;
        }

        .tab-panel.active {
            display: block;
        }

        /* En-t√™te de section */
        .section-header {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 4px solid #1e3a5f;
        }

        .section-header h1 {
            color: #1e293b;
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .section-header p {
            color: #64748b;
            font-size: 1.2em;
            font-weight: 500;
        }

        /* Formulaires */
        .form-section {
            background: #f8fafc;
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 35px;
            border: 2px solid #e2e8f0;
        }

        .form-section-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        label {
            display: block;
            color: #000000; /* Noir intense comme demand√© */
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 1.05em;
            letter-spacing: 0.2px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 18px 20px;
            border: 3px solid #cbd5e0;
            border-radius: 12px;
            font-size: 1.05em;
            transition: all 0.3s ease;
            font-family: inherit;
            color: #000000;
            background: #ffffff;
            font-weight: 500;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #1e3a5f;
            box-shadow: 0 0 0 4px rgba(30, 58, 95, 0.15);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 140px;
            color: #000000; /* Noir intense pour les observations */
            line-height: 1.7;
        }

        textarea::placeholder {
            color: #94a3b8;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        /* Interventions */
        .interventions-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 16px;
            border: 3px solid #e2e8f0;
        }

        .intervention-card {
            background: #f8fafc;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
            position: relative;
            transition: all 0.3s ease;
        }

        .intervention-card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .intervention-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .intervention-number {
            font-size: 1.25em;
            font-weight: 800;
            color: #1e3a5f;
        }

        /* Boutons */
        .btn {
            padding: 18px 36px;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #334155;
        }

        .btn-block {
            width: 100%;
            margin-top: 15px;
        }

        .btn-add {
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
            color: white;
        }

        /* Signature */
        .signature-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 16px;
            border: 3px solid #e2e8f0;
        }

        .signature-canvas {
            width: 100%;
            height: 250px;
            border: 3px solid #cbd5e0;
            border-radius: 12px;
            cursor: crosshair;
            background: #ffffff;
            touch-action: none;
        }

        .signature-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* Messages */
        .alert {
            padding: 20px 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 1.05em;
            display: none;
            align-items: center;
            gap: 12px;
        }

        .alert.show {
            display: flex;
        }

        .alert-success {
            background: #d1fae5;
            border: 3px solid #10b981;
            color: #065f46;
        }

        .alert-info {
            background: #dbeafe;
            border: 3px solid #3b82f6;
            color: #1e40af;
        }

        /* Historique */
        .history-grid {
            display: grid;
            gap: 20px;
        }

        .history-card {
            background: #f8fafc;
            padding: 30px;
            border-radius: 16px;
            border: 3px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-card:hover {
            border-color: #1e3a5f;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .history-info h3 {
            font-size: 1.3em;
            color: #1e293b;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .history-info p {
            color: #64748b;
            font-size: 1em;
            margin: 5px 0;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: #94a3b8;
            font-size: 1.2em;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Logo preview */
        .logo-preview {
            margin-top: 20px;
            padding: 25px;
            background: #f8fafc;
            border-radius: 12px;
            border: 3px dashed #cbd5e0;
            text-align: center;
        }

        .logo-preview img {
            max-width: 250px;
            max-height: 150px;
            object-fit: contain;
        }

        .logo-preview.empty {
            color: #94a3b8;
            font-style: italic;
        }

        /* Bouton nouveau bon */
        .new-bon-btn {
            display: none;
        }

        .new-bon-btn.visible {
            display: block;
        }

        /* Profil sauvegard√© indicator */
        .profile-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 8px;
            color: #065f46;
            font-weight: 700;
            margin-bottom: 25px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                font-size: 16px;
            }

            .tab-panel {
                padding: 25px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .main-tabs {
                overflow-x: auto;
                padding: 0 15px;
            }

            .main-tab {
                padding: 18px 24px;
                font-size: 1em;
                white-space: nowrap;
            }

            .section-header h1 {
                font-size: 2em;
            }

            .signature-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-panel.active {
            animation: fadeIn 0.4s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation principale -->
        <nav class="main-tabs">
            <button class="main-tab active" onclick="switchMainTab('profile')">‚öôÔ∏è Profil Entreprise</button>
            <button class="main-tab" onclick="switchMainTab('new-bon')">üìã Nouveau Bon</button>
            <button class="main-tab" onclick="switchMainTab('history')">üìÇ Historique</button>
        </nav>

        <!-- ONGLET PROFIL ENTREPRISE -->
        <div id="profileTab" class="tab-panel active">
            <div class="section-header">
                <h1>Configuration du Profil</h1>
                <p>Enregistrez les informations de votre entreprise une seule fois</p>
            </div>

            <div id="profileSavedAlert" class="profile-status" style="display: none;">
                <span>‚úì</span>
                <span>Profil enregistr√© avec succ√®s</span>
            </div>

            <form id="profileForm" class="form-section">
                <div class="form-section-title">üè¢ Informations de l'entreprise</div>

                <div class="form-group">
                    <label for="companyName">Nom de la Soci√©t√©</label>
                    <input type="text" id="companyName" placeholder="Ex: Kopilots SARL">
                </div>

                <div class="form-group">
                    <label for="siren">SIREN</label>
                    <input type="text" id="siren" placeholder="123 456 789">
                </div>

                <div class="form-group">
                    <label for="technicianName">Nom du Technicien</label>
                    <input type="text" id="technicianName" placeholder="Ex: Jean Dupont">
                </div>

                <div class="form-group">
                    <label for="companyLogo">Logo de l'entreprise</label>
                    <input type="file" id="companyLogo" accept="image/*" onchange="previewLogo(event)">
                    <div id="logoPreview" class="logo-preview empty">
                        Aucun logo s√©lectionn√©
                    </div>
                </div>

                <button type="button" class="btn btn-success btn-block" onclick="saveProfile()">
                    üíæ Enregistrer le Profil
                </button>
            </form>
        </div>

        <!-- ONGLET NOUVEAU BON -->
        <div id="newBonTab" class="tab-panel">
            <div class="section-header">
                <h1>Nouveau Bon d'Intervention</h1>
                <p id="companyNameDisplay">Configurez d'abord votre profil entreprise</p>
                <p id="bonNumberDisplay" style="color: #1e3a5f; font-weight: 700; margin-top: 10px; font-size: 1.1em;">Prochain bon : ...</p>
            </div>

            <div id="successAlert" class="alert alert-success">
                <span>‚úÖ</span>
                <span>PDF g√©n√©r√© avec succ√®s !</span>
            </div>

            <form id="interventionForm">
                <!-- Informations Client -->
                <div class="form-section">
                    <div class="form-section-title">üë§ Informations Client</div>

                    <div class="form-group">
                        <label for="clientName">Nom du Client</label>
                        <input type="text" id="clientName" placeholder="Nom complet du client">
                    </div>

                    <div class="form-group">
                        <label for="clientAddress">Adresse Compl√®te</label>
                        <input type="text" id="clientAddress" placeholder="Num√©ro, rue, ville, code postal">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="arrivalDate">üìÖ Date d'Arriv√©e</label>
                            <input type="date" id="arrivalDate">
                        </div>
                        <div class="form-group">
                            <label for="arrivalTime">üïê Heure d'Arriv√©e</label>
                            <input type="time" id="arrivalTime">
                        </div>
                    </div>
                </div>

                <!-- Interventions -->
                <div class="form-section">
                    <div class="form-section-title">üîß Interventions R√©alis√©es</div>
                    <div class="interventions-container">
                        <div id="interventionsList"></div>
                        <button type="button" class="btn btn-add btn-block" onclick="addIntervention()">
                            ‚ûï Ajouter une Intervention
                        </button>
                    </div>
                </div>

                <!-- Observations -->
                <div class="form-section">
                    <div class="form-section-title">üìù Observations</div>
                    <div class="form-group">
                        <textarea id="observations" placeholder="Notes compl√©mentaires, recommandations, points d'attention..."></textarea>
                    </div>
                </div>

                <!-- Photos -->
                <div class="form-section">
                    <div class="form-section-title">üì∑ Photos</div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="capturePhoto()" style="flex: 1; min-width: 150px;">
                                üì∏ Prendre une photo
                            </button>
                            <label for="photoUpload" class="btn btn-secondary" style="flex: 1; min-width: 150px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                üñºÔ∏è Importer une photo
                            </label>
                            <input type="file" id="photoUpload" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                        </div>
                        <div id="photosPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;"></div>
                    </div>
                </div>

                <!-- Signature -->
                <div class="form-section">
                    <div class="form-section-title">‚úçÔ∏è Signature du Client</div>
                    <div class="signature-container">
                        <div style="margin-bottom: 20px;">
                            <label style="margin-bottom: 15px;">Mode de signature :</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="setSignatureMode('draw')" id="btnDraw" style="flex: 1; min-width: 150px;">
                                    ‚úçÔ∏è Signer √† la main
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="setSignatureMode('paraph')" id="btnParaph" style="flex: 1; min-width: 150px;">
                                    üìù Parapher
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="setSignatureMode('type')" id="btnType" style="flex: 1; min-width: 150px;">
                                    ‚å®Ô∏è √âcrire le nom
                                </button>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; font-weight: 600; cursor: pointer;">
                                    <input type="checkbox" id="noSignatureCheckbox" style="width: 20px; height: 20px; cursor: pointer;" onchange="handleNoSignatureChange()">
                                    <span>‚òê Bon sans signature (permet la validation sans signer)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="drawSignatureArea" style="display: none;">
                            <canvas id="signatureCanvas" class="signature-canvas" width="800" height="250"></canvas>
                        </div>
                        
                        <div id="typeSignatureArea" style="display: none;">
                            <input type="text" id="signatureName" placeholder="Entrez le nom complet..." style="width: 100%; font-size: 1.3em; padding: 20px; text-align: center; font-family: 'Brush Script MT', cursive;">
                        </div>
                        
                        <div id="noSignatureArea" style="display: none; padding: 30px; background: #f8fafc; border-radius: 12px; text-align: center; border: 3px dashed #cbd5e0;">
                            <p style="color: #64748b; font-size: 1.1em;">‚úì Bon sans signature valid√©</p>
                        </div>
                        
                        <div class="signature-actions">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature()" style="flex: 1;">
                                üóëÔ∏è Effacer
                            </button>
                            <button type="button" class="btn btn-primary" onclick="generatePDF()" style="flex: 2;">
                                üìÑ Valider et T√©l√©charger
                            </button>
                        </div>
                        <button type="button" class="btn btn-success btn-block new-bon-btn" id="newBonBtn" onclick="createNewBon()">
                            ‚ú® Cr√©er un Nouveau Bon
                        </button>
                    </div>
                </div>
                
                <!-- Photos -->
                <div class="form-section">
                    <div class="form-section-title">üì∏ Photos</div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                            <label class="btn btn-secondary" style="flex: 1; min-width: 150px; cursor: pointer; margin: 0;">
                                <input type="file" accept="image/*" capture="environment" onchange="handlePhotoCapture(event)" style="display: none;">
                                üì∑ Prendre une Photo
                            </label>
                            <label class="btn btn-secondary" style="flex: 1; min-width: 150px; cursor: pointer; margin: 0;">
                                <input type="file" accept="image/*" multiple onchange="handlePhotoCapture(event)" style="display: none;">
                                üñºÔ∏è Importer depuis Galerie
                            </label>
                        </div>
                        <div id="photosPreview" style="background: #f8fafc; border-radius: 12px; padding: 20px; min-height: 100px; border: 2px dashed #cbd5e0;">
                            <p style="color: #94a3b8; font-style: italic; text-align: center; padding: 20px;">Aucune photo ajout√©e</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ONGLET HISTORIQUE -->
        <div id="historyTab" class="tab-panel">
            <div class="section-header">
                <h1>Historique des Bons</h1>
                <p>Retrouvez et t√©l√©chargez tous vos bons d'intervention</p>
            </div>

            <div id="historyList" class="history-grid"></div>
            <div id="emptyHistory" class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div>Aucun bon d'intervention enregistr√©</div>
                <p style="font-size: 0.9em; margin-top: 10px;">Cr√©ez votre premier bon pour le voir appara√Ætre ici</p>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let interventionCount = 0;
        let signatureCanvas, signatureCtx;
        let isDrawing = false;
        let hasSignature = false;
        let companyProfile = null;
        let history = [];
        let signatureMode = null;
        let uploadedPhotos = []; // Photos upload√©es
        let bonCounter = { year: 0, month: 0, count: 0 }; // Compteur de bons

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            loadHistory();
            loadBonCounter();
            initSignatureCanvas();
            addIntervention();
            setTodayDate();
            updateBonNumber();
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('arrivalDate').value = today;
        }
        
        // Gestion du compteur de bons
        function loadBonCounter() {
            const saved = localStorage.getItem('bon_counter');
            if (saved) {
                bonCounter = JSON.parse(saved);
            }
        }
        
        function saveBonCounter() {
            localStorage.setItem('bon_counter', JSON.stringify(bonCounter));
        }
        
        function getNextBonNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1-12
            
            // R√©initialiser le compteur si changement de mois
            if (bonCounter.year !== year || bonCounter.month !== month) {
                bonCounter = { year, month, count: 1 };
            } else {
                bonCounter.count++;
            }
            
            saveBonCounter();
            
            // Format: AAAAMMNNN (ex: 20260201, 202602100)
            const yearStr = year.toString();
            const monthStr = month.toString().padStart(2, '0');
            const countStr = bonCounter.count.toString();
            
            return yearStr + monthStr + countStr;
        }
        
        function updateBonNumber() {
            const bonNumber = getNextBonNumberPreview();
            const display = document.getElementById('bonNumberDisplay');
            if (display) {
                display.textContent = `Prochain bon : ${bonNumber}`;
            }
        }
        
        function getNextBonNumberPreview() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            
            let count = bonCounter.count;
            if (bonCounter.year !== year || bonCounter.month !== month) {
                count = 1;
            } else {
                count = bonCounter.count + 1;
            }
            
            const yearStr = year.toString();
            const monthStr = month.toString().padStart(2, '0');
            const countStr = count.toString();
            
            return yearStr + monthStr + countStr;
        }
        
        // Loader
        function showLoader(message) {
            let loader = document.getElementById('pdfLoader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'pdfLoader';
                loader.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 1.2em;';
                loader.innerHTML = `
                    <div style="width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #1e3a5f; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                    <div id="loaderMessage">${message}</div>
                `;
                document.body.appendChild(loader);
                
                // Ajouter l'animation
                const style = document.createElement('style');
                style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            } else {
                document.getElementById('loaderMessage').textContent = message;
                loader.style.display = 'flex';
            }
        }
        
        function hideLoader() {
            const loader = document.getElementById('pdfLoader');
            if (loader) {
                loader.style.display = 'none';
            }
        }
        
        // Gestion des photos
        function compressImage(dataUrl, maxWidth = 800, quality = 0.5) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Redimensionner fortement pour √©conomiser l'espace
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Qualit√© r√©duite √† 50% pour √©conomiser beaucoup d'espace
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        async function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const compressed = await compressImage(e.target.result);
                uploadedPhotos.push(compressed);
                renderPhotos();
            };
            reader.readAsDataURL(file);
        }
        
        function capturePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = handlePhotoCapture;
            input.click();
        }
        
        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const compressed = await compressImage(e.target.result);
                        uploadedPhotos.push(compressed);
                        renderPhotos();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            renderPhotos();
        }
        
        function renderPhotos() {
            const container = document.getElementById('photosPreview');
            if (!container) return;
            
            if (uploadedPhotos.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; font-style: italic; text-align: center; padding: 20px;">Aucune photo ajout√©e</p>';
                return;
            }
            
            container.innerHTML = uploadedPhotos.map((photo, index) => `
                <div style="position: relative; display: inline-block; margin: 10px;">
                    <img src="${photo}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <button type="button" onclick="removePhoto(${index})" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">√ó</button>
                </div>
            `).join('');
        }

        // Gestion du profil
        function loadProfile() {
            const saved = localStorage.getItem('company_profile');
            if (saved) {
                companyProfile = JSON.parse(saved);
                document.getElementById('companyName').value = companyProfile.companyName || '';
                document.getElementById('siren').value = companyProfile.siren || '';
                document.getElementById('technicianName').value = companyProfile.technicianName || '';
                
                if (companyProfile.logo) {
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${companyProfile.logo}" alt="Logo">`;
                    preview.classList.remove('empty');
                }
                
                document.getElementById('profileSavedAlert').style.display = 'flex';
                updateCompanyDisplay();
            }
        }

        function saveProfile() {
            try {
                const companyName = document.getElementById('companyName').value;
                const technicianName = document.getElementById('technicianName').value;
                const logoImg = document.getElementById('logoPreview').querySelector('img');
                const logoSrc = logoImg ? logoImg.src : null;

                companyProfile = {
                    companyName: companyName,
                    siren: document.getElementById('siren').value,
                    technicianName: technicianName,
                    logo: logoSrc
                };

                try {
                    localStorage.setItem('company_profile', JSON.stringify(companyProfile));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        alert('‚ö†Ô∏è Le logo est trop volumineux. Veuillez utiliser une image plus petite.');
                        return;
                    }
                    throw e;
                }
                
                document.getElementById('profileSavedAlert').style.display = 'flex';
                updateCompanyDisplay();
                
                alert('‚úÖ Profil enregistr√© avec succ√®s !');
            } catch (error) {
                console.error('Erreur saveProfile:', error);
                alert('‚ùå Erreur lors de l\'enregistrement : ' + error.message);
            }
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier image');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Compresser fortement le logo pour √©viter quota exceeded
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 300; // R√©duit √† 300px max
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Qualit√© r√©duite √† 60%
                    const compressedLogo = canvas.toDataURL('image/jpeg', 0.6);
                    
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${compressedLogo}" alt="Logo">`;
                    preview.classList.remove('empty');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateCompanyDisplay() {
            if (companyProfile) {
                document.getElementById('companyNameDisplay').textContent = companyProfile.companyName;
            }
        }

        // Navigation
        function switchMainTab(tabName) {
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tabName === 'profile') {
                document.getElementById('profileTab').classList.add('active');
            } else if (tabName === 'new-bon') {
                document.getElementById('newBonTab').classList.add('active');
            } else if (tabName === 'history') {
                document.getElementById('historyTab').classList.add('active');
                renderHistory();
            }
        }

        // Gestion de la signature
        function handleNoSignatureChange() {
            const checkbox = document.getElementById('noSignatureCheckbox');
            if (checkbox.checked) {
                // D√©sactiver les autres modes
                signatureMode = 'none';
                document.getElementById('drawSignatureArea').style.display = 'none';
                document.getElementById('typeSignatureArea').style.display = 'none';
                document.querySelectorAll('#btnDraw, #btnParaph, #btnType').forEach(btn => {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                });
            } else {
                signatureMode = null;
                document.querySelectorAll('#btnDraw, #btnParaph, #btnType').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
            }
        }
        
        function setSignatureMode(mode) {
            signatureMode = mode;
            hasSignature = false;
            
            // Reset tous les boutons
            document.querySelectorAll('#btnDraw, #btnParaph, #btnType, #btnNone').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            
            // Cacher toutes les zones
            document.getElementById('drawSignatureArea').style.display = 'none';
            document.getElementById('typeSignatureArea').style.display = 'none';
            document.getElementById('noSignatureArea').style.display = 'none';
            
            // Afficher la zone appropri√©e
            if (mode === 'draw' || mode === 'paraph') {
                document.getElementById('drawSignatureArea').style.display = 'block';
                document.getElementById('btn' + (mode === 'draw' ? 'Draw' : 'Paraph')).style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%)';
                document.getElementById('btn' + (mode === 'draw' ? 'Draw' : 'Paraph')).style.color = 'white';
                initSignatureCanvas();
                if (mode === 'paraph') {
                    signatureCtx.font = '48px "Brush Script MT", cursive';
                }
            } else if (mode === 'type') {
                document.getElementById('typeSignatureArea').style.display = 'block';
                document.getElementById('btnType').style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%)';
                document.getElementById('btnType').style.color = 'white';
                document.getElementById('signatureName').value = '';
                document.getElementById('signatureName').addEventListener('input', function() {
                    hasSignature = this.value.trim().length > 0;
                });
            } else if (mode === 'none') {
                document.getElementById('noSignatureArea').style.display = 'block';
                document.getElementById('btnNone').style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%)';
                document.getElementById('btnNone').style.color = 'white';
                hasSignature = true;
            }
        }
        
        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) return;
            
            signatureCtx = signatureCanvas.getContext('2d');
            
            // Nettoyer le canvas
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            
            // Retirer les anciens listeners
            const newCanvas = signatureCanvas.cloneNode(true);
            signatureCanvas.parentNode.replaceChild(newCanvas, signatureCanvas);
            signatureCanvas = newCanvas;
            signatureCtx = signatureCanvas.getContext('2d');

            // Events souris
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Events tactiles
            signatureCanvas.addEventListener('touchstart', handleTouch);
            signatureCanvas.addEventListener('touchmove', handleTouch);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            hasSignature = true;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureCtx.strokeStyle = '#000000';
            signatureCtx.lineWidth = 3;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(
                e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup',
                { clientX: touch.clientX, clientY: touch.clientY }
            );
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            if (signatureMode === 'draw' || signatureMode === 'paraph') {
                if (signatureCtx && signatureCanvas) {
                    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                }
            } else if (signatureMode === 'type') {
                document.getElementById('signatureName').value = '';
            }
            hasSignature = false;
            if (signatureMode === 'none') {
                hasSignature = true;
            }
        }

        // Gestion des interventions
        function addIntervention() {
            interventionCount++;
            const container = document.getElementById('interventionsList');
            const card = document.createElement('div');
            card.className = 'intervention-card';
            card.id = `intervention-${interventionCount}`;
            
            card.innerHTML = `
                <div class="intervention-header">
                    <div class="intervention-number">Intervention #${interventionCount}</div>
                    ${interventionCount > 1 ? `<button type="button" class="btn btn-danger" onclick="removeIntervention(${interventionCount})" style="padding: 10px 20px;">‚ùå Supprimer</button>` : ''}
                </div>
                <div class="form-group">
                    <label>Description de l'intervention *</label>
                    <textarea class="intervention-desc" placeholder="D√©crivez en d√©tail l'intervention r√©alis√©e..."></textarea>
                </div>
            `;
            
            container.appendChild(card);
        }

        function removeIntervention(id) {
            const card = document.getElementById(`intervention-${id}`);
            if (card) {
                card.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => card.remove(), 300);
            }
        }

        // Nouveau bon
        function createNewBon() {
            if (confirm('√ätes-vous s√ªr de vouloir cr√©er un nouveau bon ? Les donn√©es actuelles non enregistr√©es seront perdues.')) {
                // R√©initialiser TOUS les champs du formulaire
                document.getElementById('interventionForm').reset();
                document.getElementById('clientName').value = '';
                document.getElementById('clientAddress').value = '';
                document.getElementById('arrivalDate').value = '';
                document.getElementById('arrivalTime').value = '';
                document.getElementById('observations').value = '';
                
                // R√©initialiser la signature
                clearSignature();
                
                // R√©initialiser les interventions
                document.getElementById('interventionsList').innerHTML = '';
                interventionCount = 0;
                addIntervention();
                
                // R√©initialiser les boutons et messages
                document.getElementById('newBonBtn').classList.remove('visible');
                document.getElementById('successAlert').classList.remove('show');
                
                // R√©initialiser le mode de signature
                signatureMode = null;
                document.getElementById('drawSignatureArea').style.display = 'none';
                document.getElementById('typeSignatureArea').style.display = 'none';
                document.getElementById('noSignatureArea').style.display = 'none';
                document.querySelectorAll('#btnDraw, #btnParaph, #btnType, #btnNone').forEach(btn => {
                    btn.style.background = '';
                    btn.style.color = '';
                });
                
                // R√©initialiser COMPL√àTEMENT les photos
                uploadedPhotos = [];
                renderPhotos();
                
                // R√©initialiser la date √† aujourd'hui
                setTodayDate();
                
                // Mettre √† jour l'affichage du prochain num√©ro
                updateBonNumber();
                
                // Scroll en haut
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // G√©n√©ration PDF
        function generatePDF() {
            // Afficher le loader
            showLoader('G√©n√©ration du PDF en cours...');
            
            const clientName = document.getElementById('clientName').value;
            const clientAddress = document.getElementById('clientAddress').value;
            const arrivalDate = document.getElementById('arrivalDate').value;
            const arrivalTime = document.getElementById('arrivalTime').value;
            
            // Cr√©er dateObj IMM√âDIATEMENT pour l'utiliser partout
            const dateObj = arrivalDate ? new Date(arrivalDate) : new Date();

            // R√©cup√©rer les interventions
            const interventions = [];
            document.querySelectorAll('.intervention-desc').forEach(textarea => {
                if (textarea.value.trim()) {
                    interventions.push(textarea.value.trim());
                }
            });

            const observations = document.getElementById('observations').value;
            
            // R√©cup√©rer la signature selon le mode - NON BLOQUANT
            let signatureData = null;
            const noSignatureChecked = document.getElementById('noSignatureCheckbox')?.checked;
            
            if (signatureMode === 'draw' || signatureMode === 'paraph') {
                signatureData = signatureCanvas.toDataURL('image/png');
            } else if (signatureMode === 'type') {
                const name = document.getElementById('signatureName').value;
                if (name && name.trim()) {
                    // Cr√©er une image de signature typ√©e
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = 400;
                    tempCanvas.height = 100;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.fillStyle = '#000000';
                    tempCtx.font = '36px "Brush Script MT", cursive';
                    tempCtx.textAlign = 'center';
                    tempCtx.textBaseline = 'middle';
                    tempCtx.fillText(name, 200, 50);
                    signatureData = tempCanvas.toDataURL('image/png');
                }
            } else if (noSignatureChecked || signatureMode === 'none') {
                // Cr√©er une image "Bon sans signature"
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 400;
                tempCanvas.height = 100;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.fillStyle = '#64748b';
                tempCtx.font = 'bold 20px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.textBaseline = 'middle';
                tempCtx.fillText('‚úì Bon sans signature', 200, 50);
                signatureData = tempCanvas.toDataURL('image/png');
            }
            
            // Si aucune signature, cr√©er une signature vide par d√©faut
            if (!signatureData) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 400;
                tempCanvas.height = 100;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.fillStyle = '#cbd5e0';
                tempCtx.font = 'italic 18px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.textBaseline = 'middle';
                tempCtx.fillText('(Signature non renseign√©e)', 200, 50);
                signatureData = tempCanvas.toDataURL('image/png');
            }
            
            // R√©cup√©rer les photos
            const photos = uploadedPhotos.slice(); // Copie du tableau
            
            // G√©n√©rer le num√©ro de bon
            const bonNumber = getNextBonNumber();
            
            // G√©n√©rer le PDF avec gestion d'erreur
            try {
                console.log('=== D√âBUT G√âN√âRATION PDF PREMIUM ===');
                console.log('Num√©ro de bon:', bonNumber);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                let yPos = 0;
                
                console.log('=== APPLICATION DU DESIGN PREMIUM MODERNE SOMBRE ===');
                
                // ============ FOND SOMBRE MODERNE ============
                // Fond gris fonc√© pour toute la page
                doc.setFillColor(34, 34, 34); // #222
                doc.rect(0, 0, 210, 297, 'F');
                
                // Bande bleue moderne en haut
                doc.setFillColor(0, 153, 255); // #0099ff
                doc.rect(0, 0, 210, 5, 'F');
                
                // ============ EN-T√äTE MODERNE ============
                yPos = 20;
                
                // Logo/Marque √† gauche - POLICE √âL√âGANTE
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(26);
                doc.setFont('helvetica', 'bold');
                if (companyProfile && companyProfile.companyName) {
                    doc.text(companyProfile.companyName.toUpperCase(), 20, yPos);
                } else {
                    doc.text('KES SOLUTIONS', 20, yPos);
                }
                
                doc.setTextColor(170, 170, 170);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('KOPILOTS ENERGIE SYSTEME', 20, yPos + 6);
                
                // NUM√âRO DE BON - TR√àS VISIBLE √Ä DROITE - POLICE √âL√âGANTE
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text("BON D'INTERVENTION", 190, yPos - 5, { align: 'right' });
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(34);
                doc.setFont('times', 'bold'); // Police serif √©l√©gante pour le num√©ro
                doc.text(`N¬∞ ${bonNumber}`, 190, yPos + 8, { align: 'right' });
                
                // Date
                doc.setTextColor(170, 170, 170);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const now = new Date();
                doc.text(`Date: ${now.toLocaleDateString('fr-FR')}`, 190, yPos + 15, { align: 'right' });
                
                // Ligne de s√©paration
                yPos = 45;
                doc.setDrawColor(68, 68, 68);
                doc.setLineWidth(0.5);
                doc.line(20, yPos, 190, yPos);
                
                // ============ BADGE TECHNICIEN ============
                yPos = 55;
                
                // Fond du badge avec d√©grad√© simul√©
                doc.setFillColor(51, 51, 51);
                doc.roundedRect(20, yPos, 80, 18, 3, 3, 'F');
                doc.setDrawColor(85, 85, 85);
                doc.setLineWidth(0.5);
                doc.roundedRect(20, yPos, 80, 18, 3, 3, 'S');
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('EXPERT EN CHARGE', 25, yPos + 6);
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                if (companyProfile && companyProfile.technicianName) {
                    doc.text(companyProfile.technicianName.toUpperCase(), 25, yPos + 14);
                }
                
                // ============ GRILLE INFORMATIONS ============
                yPos = 85;
                
                // SECTION CLIENT - Carte gauche
                doc.setFillColor(40, 40, 40);
                doc.roundedRect(20, yPos, 80, 45, 2, 2, 'F');
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMATIONS CLIENT', 25, yPos + 8);
                
                doc.setTextColor(255, 255, 255); // BLANC pour le texte
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                let clientY = yPos + 16;
                if (clientName) {
                    const nameLines = doc.splitTextToSize(clientName, 70);
                    doc.text(nameLines, 25, clientY);
                    clientY += nameLines.length * 5;
                }
                
                if (clientAddress) {
                    const addrLines = doc.splitTextToSize(clientAddress, 70);
                    doc.text(addrLines, 25, clientY);
                }
                
                // SECTION D√âTAILS - Carte droite
                doc.setFillColor(40, 40, 40);
                doc.roundedRect(110, yPos, 80, 45, 2, 2, 'F');
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('D√âTAILS INTERVENTION', 115, yPos + 8);
                
                doc.setTextColor(255, 255, 255); // BLANC pour le texte
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                let detailY = yPos + 16;
                if (arrivalDate) {
                    doc.text(`Date: ${dateObj.toLocaleDateString('fr-FR')}`, 115, detailY);
                    detailY += 6;
                }
                if (arrivalTime) {
                    doc.text(`Heure: ${arrivalTime}`, 115, detailY);
                    detailY += 6;
                }
                
                // Logo si disponible
                if (companyProfile && companyProfile.logo) {
                    try {
                        doc.addImage(companyProfile.logo, 'PNG', 115, detailY, 20, 20);
                    } catch (e) {
                        console.error('Erreur logo:', e);
                    }
                }
                
                console.log('Bandeau et badges appliqu√©s');

            // ============ INTERVENTIONS - STYLE MODERNE SOMBRE ============
            if (interventions.length > 0) {
                yPos = 145;
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('INTERVENTIONS R√âALIS√âES', 20, yPos);
                
                yPos += 10;
                
                interventions.forEach((intervention, index) => {
                    if (yPos > 240) {
                        doc.addPage();
                        // Refaire le fond sombre sur la nouvelle page
                        doc.setFillColor(34, 34, 34);
                        doc.rect(0, 0, 210, 297, 'F');
                        doc.setFillColor(0, 153, 255);
                        doc.rect(0, 0, 210, 5, 'F');
                        yPos = 20;
                    }
                    
                    // Carte intervention sombre
                    const lines = doc.splitTextToSize(intervention, 160);
                    const cardHeight = (lines.length * 6) + 10;
                    
                    doc.setFillColor(40, 40, 40);
                    doc.roundedRect(20, yPos, 170, cardHeight, 3, 3, 'F');
                    
                    // Num√©ro intervention
                    doc.setTextColor(0, 153, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}.`, 25, yPos + 7);
                    
                    // Texte intervention EN BLANC
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(lines, 35, yPos + 7);
                    
                    yPos += cardHeight + 5;
                });
            }

            // ============ OBSERVATIONS - STYLE MODERNE SOMBRE ============
            if (observations) {
                yPos += 10;
                
                if (yPos > 230) {
                    doc.addPage();
                    doc.setFillColor(34, 34, 34);
                    doc.rect(0, 0, 210, 297, 'F');
                    doc.setFillColor(0, 153, 255);
                    doc.rect(0, 0, 210, 5, 'F');
                    yPos = 20;
                }
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('OBSERVATIONS', 20, yPos);
                
                yPos += 8;
                
                const obsLines = doc.splitTextToSize(observations, 160);
                const obsHeight = (obsLines.length * 6) + 10;
                
                doc.setFillColor(40, 40, 40);
                doc.roundedRect(20, yPos, 170, obsHeight, 3, 3, 'F');
                
                // Texte observations EN BLANC
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(obsLines, 25, yPos + 7);
                
                yPos += obsHeight + 10;
            }

            // ============ PHOTOS - STYLE MODERNE SOMBRE ============
            if (photos.length > 0) {
                yPos += 10;
                
                if (yPos > 220) {
                    doc.addPage();
                    doc.setFillColor(34, 34, 34);
                    doc.rect(0, 0, 210, 297, 'F');
                    doc.setFillColor(0, 153, 255);
                    doc.rect(0, 0, 210, 5, 'F');
                    yPos = 20;
                }
                
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('PHOTOS', 20, yPos);
                yPos += 10;
                
                let photoX = 20;
                let photoY = yPos;
                const photoWidth = 75;
                const photoHeight = 56;
                const spacing = 15;
                
                photos.forEach((photo, index) => {
                    if (photoY + photoHeight > 260) {
                        doc.addPage();
                        doc.setFillColor(34, 34, 34);
                        doc.rect(0, 0, 210, 297, 'F');
                        doc.setFillColor(0, 153, 255);
                        doc.rect(0, 0, 210, 5, 'F');
                        photoY = 20;
                        photoX = 20;
                    }
                    
                    try {
                        // Fond sombre pour photo
                        doc.setFillColor(40, 40, 40);
                        doc.roundedRect(photoX, photoY, photoWidth, photoHeight, 2, 2, 'F');
                        
                        // Photo
                        doc.addImage(photo, 'JPEG', photoX + 2, photoY + 2, photoWidth - 4, photoHeight - 4);
                        
                        // Bordure bleue
                        doc.setDrawColor(0, 153, 255);
                        doc.setLineWidth(1);
                        doc.roundedRect(photoX, photoY, photoWidth, photoHeight, 2, 2, 'S');
                    } catch (e) {
                        console.error('Erreur photo:', e);
                    }
                    
                    if ((index + 1) % 2 === 0) {
                        photoX = 20;
                        photoY += photoHeight + spacing;
                    } else {
                        photoX += photoWidth + spacing;
                    }
                });
                
                yPos = photoY + photoHeight + 15;
            }
            
            // ============ SIGNATURE - STYLE MODERNE SOMBRE ============
            if (yPos > 210) {
                doc.addPage();
                doc.setFillColor(34, 34, 34);
                doc.rect(0, 0, 210, 297, 'F');
                doc.setFillColor(0, 153, 255);
                doc.rect(0, 0, 210, 5, 'F');
                yPos = 20;
            } else {
                yPos += 15;
            }
            
            // Zone signature avec fond blanc pour contraste
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(20, yPos, 90, 45, 3, 3, 'F');
            
            doc.setTextColor(0, 153, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('SIGNATURE DU CLIENT', 25, yPos + 8);
            
            // Ligne pour signature
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(25, yPos + 40, 105, yPos + 40);
            
            if (signatureData) {
                try {
                    doc.addImage(signatureData, 'PNG', 25, yPos + 12, 70, 25);
                } catch (e) {
                    console.error('Erreur signature:', e);
                }
            }
            
            // ============ FOOTER MODERNE KES SOLUTIONS ============
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                
                // Ligne de s√©paration
                doc.setDrawColor(68, 68, 68);
                doc.setLineWidth(0.5);
                doc.line(20, 275, 190, 275);
                
                // Infos √† gauche
                doc.setTextColor(119, 119, 119);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                if (companyProfile && companyProfile.siren) {
                    doc.text(`SIREN: ${companyProfile.siren}`, 20, 282);
                }
                doc.setFontSize(9);
                doc.text(`Document ${i}/${pageCount}`, 20, 288);
                
                // KES SOLUTIONS √† droite
                doc.setTextColor(0, 153, 255);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Administr√© par KES SOLUTIONS', 190, 282, { align: 'right' });
                
                doc.setTextColor(119, 119, 119);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('KOPILOTS ENERGIE SYSTEME', 190, 288, { align: 'right' });
            }

            // Sauvegarder dans l'historique
            const bonData = {
                bonNumber,
                clientName,
                clientAddress,
                arrivalDate: arrivalDate ? new Date(arrivalDate).toLocaleDateString('fr-FR') : '',
                arrivalTime,
                interventions,
                observations,
                signatureData,
                // Photos exclues pour √©viter quota exceeded localStorage
                createdAt: new Date().toISOString(),
                companyProfile: companyProfile ? { ...companyProfile } : null
            };

            history.unshift(bonData);
            // Limiter √† 20 bons maximum pour √©conomiser l'espace localStorage
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            saveHistory();

            // T√©l√©charger
            const filename = `Bon_Intervention_${clientName.replace(/\s+/g, '_')}_${dateObj.toISOString().split('T')[0]}.pdf`;
            doc.save(filename);

            // Afficher le succ√®s
            document.getElementById('successAlert').classList.add('show');
            document.getElementById('newBonBtn').classList.add('visible');

            setTimeout(() => {
                document.getElementById('successAlert').classList.remove('show');
            }, 5000);
            
            hideLoader();
            
        } catch (error) {
            hideLoader();
            console.error('Erreur g√©n√©ration PDF:', error);
            alert('‚ùå Erreur lors de la g√©n√©ration du PDF : ' + error.message);
        }
    }

        // Historique
        function loadHistory() {
            const saved = localStorage.getItem('bons_history');
            if (saved) {
                history = JSON.parse(saved);
            }
        }

        function saveHistory() {
            try {
                localStorage.setItem('bons_history', JSON.stringify(history));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    // Quota d√©pass√© - supprimer les anciens bons
                    console.warn('Quota localStorage d√©pass√©, nettoyage...');
                    history = history.slice(0, 10); // Garder seulement les 10 plus r√©cents
                    try {
                        localStorage.setItem('bons_history', JSON.stringify(history));
                    } catch (e2) {
                        console.error('Impossible de sauvegarder l\'historique m√™me apr√®s nettoyage');
                    }
                }
            }
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            const emptyState = document.getElementById('emptyHistory');

            if (history.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = history.map((bon, index) => `
                <div class="history-card">
                    <div class="history-info">
                        <h3>${bon.clientName}</h3>
                        <p>üìç ${bon.clientAddress}</p>
                        <p>üìÖ ${bon.arrivalDate} ‚Ä¢ üïê ${bon.arrivalTime}</p>
                        <p style="color: #94a3b8; font-size: 0.9em;">Cr√©√© le ${new Date(bon.createdAt).toLocaleDateString('fr-FR')}</p>
                    </div>
                    <button class="btn btn-primary" onclick="redownloadBon(${index})">
                        üì• T√©l√©charger
                    </button>
                </div>
            `).join('');
        }

        function redownloadBon(index) {
            const bon = history[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPos = 20;

            // Logo
            if (bon.companyProfile && bon.companyProfile.logo) {
                try {
                    doc.addImage(bon.companyProfile.logo, 'PNG', 15, yPos, 45, 45);
                } catch (e) {}
            }

            // En-t√™te
            if (bon.companyProfile) {
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                if (bon.companyProfile.companyName) doc.text(bon.companyProfile.companyName, 70, yPos + 10);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                let infoYPos = yPos + 18;
                if (bon.companyProfile.siren) {
                    doc.text(`SIREN: ${bon.companyProfile.siren}`, 70, infoYPos);
                    infoYPos += 6;
                }
                if (bon.companyProfile.technicianName) {
                    doc.text(`Technicien: ${bon.companyProfile.technicianName}`, 70, infoYPos);
                }
            }

            // Titre
            yPos = 75;
            doc.setFillColor(30, 58, 95);
            doc.rect(0, yPos, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('BON D\'INTERVENTION', 105, yPos + 13, { align: 'center' });

            // Client
            yPos = 105;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            
            doc.setFont(undefined, 'bold');
            doc.text('CLIENT:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(bon.clientName, 50, yPos);

            yPos += 8;
            doc.setFont(undefined, 'bold');
            doc.text('ADRESSE:', 20, yPos);
            doc.setFont(undefined, 'normal');
            const addressLines = doc.splitTextToSize(bon.clientAddress, 150);
            doc.text(addressLines, 50, yPos);
            yPos += (addressLines.length * 6);

            yPos += 5;
            doc.setFont(undefined, 'bold');
            doc.text('DATE:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(bon.arrivalDate, 50, yPos);

            doc.setFont(undefined, 'bold');
            doc.text('HEURE:', 110, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(bon.arrivalTime, 140, yPos);

            // Interventions
            yPos += 15;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('INTERVENTIONS R√âALIS√âES:', 20, yPos);

            yPos += 8;
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');

            bon.interventions.forEach((intervention, i) => {
                const text = `${i + 1}. ${intervention}`;
                const lines = doc.splitTextToSize(text, 170);
                
                if (yPos + (lines.length * 6) > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.text(lines, 20, yPos);
                yPos += (lines.length * 6) + 5;
            });

            // Observations
            if (bon.observations) {
                yPos += 5;
                
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('OBSERVATIONS:', 20, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                const obsLines = doc.splitTextToSize(bon.observations, 170);
                doc.text(obsLines, 20, yPos);
                yPos += (obsLines.length * 6);
            }

            // Signature
            yPos += 15;
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('SIGNATURE DU CLIENT:', 20, yPos);
            
            yPos += 5;
            doc.addImage(bon.signatureData, 'PNG', 20, yPos, 90, 36);
            
            yPos += 40;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text(`Date du bon: ${bon.arrivalDate}`, 20, yPos);

            // Footer KES SOLUTIONS
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(15, 285, 195, 285);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Administr√© par KES SOLUTIONS', 105, 290, { align: 'center' });
                doc.setFontSize(8);
                doc.text(`Page ${i} / ${pageCount}`, 195, 290, { align: 'right' });
            }

            const filename = `Bon_Intervention_${bon.clientName.replace(/\s+/g, '_')}_${bon.arrivalDate.replace(/\//g, '-')}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>
