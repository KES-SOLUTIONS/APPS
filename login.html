<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connexion - KES Solutions</title>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; background: #070707; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .login-container { background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); width: 100%; max-width: 400px; text-align: center; }
    input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 40px; border: 1px solid #fff; background: transparent; color: #fff; outline: none; box-sizing: border-box; }
    option { background: #070707; color: #fff; }
    button { width: 100%; padding: 14px; margin-top: 20px; border: none; border-radius: 40px; background: linear-gradient(45deg, #0d10d8, #cb0fd1); color: #fff; font-weight: bold; cursor: pointer; }
    .toggle-btn { margin-top: 15px; font-size: 0.8em; color: rgba(255,255,255,0.5); cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="login-container">
    <h2 id="form-title">CONNEXION</h2>

    <div id="login-fields">
      <input type="text" id="login-id" placeholder="Téléphone ou Email">
      <input type="password" id="login-pass" placeholder="Mot de passe">
      <button onclick="loginUser()">SE CONNECTER</button>
    </div>

    <div id="register-fields" style="display:none;">
      <input type="text" id="reg-name" placeholder="Nom complet">
      <input type="text" id="reg-phone" placeholder="Téléphone">
      <input type="email" id="reg-email" placeholder="Email">
      <input type="password" id="reg-pass" placeholder="Mot de passe">
      <select id="reg-role">
        <option value="tech">Technicien (Terrain)</option>
        <option value="manager">Responsable (Bureau)</option>
      </select>
      <button onclick="registerUser()">S'INSCRIRE</button>
    </div>

    <p class="toggle-btn" onclick="toggleForm()" id="toggle-text">Pas de compte ? S'inscrire</p>
  </div>

  <script>
    // IMPORTANT: mets ici TON URL /exec du déploiement (pas /dev)
    const API_URL = "COLLE_ICI_TON_URL_EXEC";

    function toggleForm() {
      const isLogin = document.getElementById('login-fields').style.display !== 'none';
      document.getElementById('login-fields').style.display = isLogin ? 'none' : 'block';
      document.getElementById('register-fields').style.display = isLogin ? 'block' : 'none';
      document.getElementById('form-title').innerText = isLogin ? 'INSCRIPTION' : 'CONNEXION';
      document.getElementById('toggle-text').innerText = isLogin ? 'Déjà un compte ? Connexion' : 'Pas de compte ? S\'inscrire';
    }

    async function loginUser() {
      const id = document.getElementById('login-id').value.trim();
      const pass = document.getElementById('login-pass').value;

      if (!id || !pass) return alert("Remplis les champs.");

      const url = `${API_URL}?action=login&id=${encodeURIComponent(id)}&pass=${encodeURIComponent(pass)}`;

      let r;
      try {
        const res = await fetch(url, { method: "GET" });
        r = await res.json();
      } catch (e) {
        return alert("Erreur API. Vérifie le déploiement Apps Script (/exec) et l'accès 'Tout le monde'.");
      }

      if (r && r.success) {
        sessionStorage.setItem('kes_authenticated', 'true');
        localStorage.setItem('kes_user', JSON.stringify({
          id: r.user_id,
          role: r.role,
          name: r.name,
          email: r.email
        }));

        window.location.href = (r.role === 'manager') ? 'manager.html' : 'index.html';
      } else {
        alert("Identifiants incorrects");
      }
    }

    async function registerUser() {
      const payload = {
        action: 'register',
        name: document.getElementById('reg-name').value.trim(),
        phone: document.getElementById('reg-phone').value.trim(),
        email: document.getElementById('reg-email').value.trim(),
        pass: document.getElementById('reg-pass').value,
        role: document.getElementById('reg-role').value
      };

      if (!payload.name || !payload.phone || !payload.email || !payload.pass) {
        return alert("Remplis tous les champs.");
      }

      let r;
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        r = await res.json();
      } catch (e) {
        return alert("Erreur API. Vérifie le déploiement Apps Script (/exec) et l'accès 'Tout le monde'.");
      }

      if (r && r.success) {
        alert("Compte créé !");
        toggleForm();
      } else {
        alert(r && r.error ? r.error : "Erreur inscription");
      }
    }
  </script>
</body>
</html>
